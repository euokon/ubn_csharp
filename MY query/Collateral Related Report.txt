1. Collateral Coverage and Loan Value (LTV) Ratio>>>DWH<<<
select u.customer_name,
       u.cust_no,
       v.category_name,
       u.tot_exposure,
       nvl(v.tot_value, 1) tot_value,
       case
         when u.tot_exposure > 0 and v.tot_value > 0 then
          round((u.tot_exposure / v.tot_value) * 100, 2)
         else
          1
       END LTV,
       case
         when u.tot_exposure > 0 and v.tot_value > 0 then
          round((v.tot_value / u.tot_exposure) * 100, 2)
         else
          1
       END LTVCOVERAGE_RATIO,
       yy.classification,
       zz.region,
       yy.major_biz_segment,
       yy.relationship_manager
  from tmp_tot_exposure   u,
       tmp_tot_value      v,
       crm_clr_report_new yy,
       crm_branch_region  zz
 where u.cust_no = v.liab_no(+)
   and u.cust_no = yy.cust_no(+)
   and yy.branch_code = zz.branch_code


2.Collateral Monitoring>>>>DWH<<<stg_uat.PKG_SSRS_REPORTS_2.PRC_COLLATERAL_DETAILS


3.Collateral Monitoring â€“ Expired Insurance>>>>DWH<<<stg_uat.PKG_SSRS_REPORTS_4.PRC_COLLATERAL_INSR_EXPRD
PACKAGE BODY pkg_ssrs_reports_4 is

  procedure prc_wht_on_deposits(in_startdt in date,
                                in_enddt   in date,
                                ret        out sys_refcursor) is
  begin
    open ret for
      select bb.contract_ref_no,
             bb.customer_no,
             bb.customer_name,
             bb.booking_date,
             bb.value_date,
             bb.maturity_date,
             bb.currency,
             bb.amount,
             bb.face_value,
             bb.tenor,
             bb.rate,
             cc.amt             calculated_int_amt,
             aa.lcy_amount      wht_charged,
             bb.product_code,
             bb.contract_status,
             aa.trn_dt
        from (select trn_dt, trn_ref_no, trn_code, lcy_amount, ac_no
                from acvw_all_ac_entries@fcubs_dr
               where trn_dt between in_startdt and in_enddt
                 and substr(trn_ref_no, 4, 4) in
                     ('TCTD', 'TDIP', 'FMDP', 'DSCD', 'DSID', 'TDCC', 'TDIC')
                 and trn_code = 'TAX'
                 and ac_no in ('250100002', '250100001')) aa,
             (select a.contract_ref_no,
                     a.counterparty customer_no,
                     nvl(nvl(c.customer_name1, c.full_name), c.short_name) customer_name,
                     b.booking_date,
                     b.value_date,
                     b.maturity_date,
                     b.amount,
                     b.lcy_amount face_value,
                     round(b.main_comp_rate, 2) rate,
                     b.tenor,
                     b.currency,
                     b.product product_code,
                     a.contract_status
                from cstb_contract@fcubs_dr        a,
                     ldtb_contract_master@fcubs_dr b,
                     sttm_customer@fcubs_dr        c
               where a.contract_ref_no = b.contract_ref_no
                 and a.latest_version_no = b.version_no
                 and a.counterparty = c.customer_no
                 and a.contract_status in ('A', 'L')) bb,
             (select contract_ref_no, sum(calculated_amount) amt
                from (select aa.contract_ref_no,
                             start_date,
                             nvl(end_date, trunc(sysdate)) end_date,
                             nvl(no_of_days,
                                 nvl(end_date, trunc(sysdate)) - start_date) no_of_days,
                             daily_average_amount,
                             round(decode(calculated_amount,
                                          0,
                                          (nvl(no_of_days,
                                               nvl(end_date, trunc(sysdate)) -
                                               start_date) *
                                          daily_average_amount),
                                          calculated_amount),
                                   2) calculated_amount
                        from ldtb_contract_iccf_calc@fcubs_dr aa,
                             cstb_contract@fcubs_dr           bb
                       where aa.contract_ref_no = bb.contract_ref_no)
               group by contract_ref_no) cc
       where aa.trn_ref_no = bb.contract_ref_no
         and aa.trn_ref_no = cc.contract_ref_no(+);
  end;

  procedure prc_instant_card_rpt(in_startdt in date,
                                 in_enddt   in date,
                                 in_branch  in varchar2,
                                 ret        out sys_refcursor) is
  begin
    
    update v_cardaccount_req set hotlisteddate  =  null 
        where hotlisteddate = 'NULL';
        
        commit;
        
    open ret for
      select a.accountnumber,
             c.ac_desc,
             b.cardprogram,
             a.status,
             a.hotlisteduser,
             to_date(a.hotlisteddate, 'MM/dd/yyyy HH:MI:SS AM') hotlisteddate,
             a.branchcode,
             d.branch_name
        from v_cardaccount_req          a,
             v_cardprofiles             b,
             dw_cust_account c,
             dw_sttm_branch       d
       where a.cardprofileid = b.id
         and a.accountnumber = c.cust_ac_no
         and a.branchcode = d.branch_code
         and a.status = 'Hotlisted'
         and trunc(to_date(a.hotlisteddate, 'MM/dd/yyyy HH:MI:SS AM')) between
             in_startdt and in_enddt
         and a.branchcode = in_branch;
  end;

  procedure prc_hotlisted_rpt(in_startdt in date,
                              in_enddt   in date,
                              ret        out sys_refcursor) is
  begin
    open ret for
      select a.accountnumber,
             b.cardprogram,
             a.status,
             a.hotlisteduser,
             to_date(a.hotlisteddate, 'MM/dd/yyyy HH:MI:SS AM') hotlisteddate,
             a.branchcode
        from v_cardaccount_req          a,
             v_cardprofiles             b,
             sttm_cust_account@fcubs_dr c,
             dw_sttm_branch       d
       where a.cardprofileid = b.id
         and a.accountnumber = c.cust_ac_no
         and a.branchcode = d.branch_code
         and a.status = 'Hotlisted'
         and trunc(to_date(a.hotlisteddate, 'MM/dd/yyyy HH:MI:SS AM')) between
             in_startdt and in_enddt;
  end;

  procedure prc_int_fee_taken(in_startdt in date,
                              in_enddt   in date,
                              ret        out sys_refcursor) is
  begin
    open ret for
      select distinct substr(a.trn_ref_no, 1, 3) trans_branch,
                      e.branch_name trans_branch_name,
                      a.ac_branch acct_branch,
                      related_account,
                      a.related_customer customer_no,
                      h.customer_name1 customer_name,
                      j.book_date booking_date,
                      j.product_code,
                      g.product_desc product_description,
                      a.drcr_ind,
                      (select narration
                         from fcubslive.get_narration@fcubs_dr nn
                        where nn.trn_ref_no = a.trn_ref_no
                          and nn.ac_entry_sr_no = a.ac_entry_sr_no
                          and nn.trn_code = a.trn_code) narration,
                      j.maturity_date,
                      i.date_of_birth dat_of_birth,
                      nvl(i.telephone, i.mobile_number) customer_phone,
                      j.amount_disbursed loan_amount,
                      a.lcy_amount ins_fee,
                      case
                        when a.drcr_ind = 'C' then
                         round((a.lcy_amount / j.amount_disbursed) * 100, 2)
                      end premium_ratio,
                      round(months_between(j.maturity_date, j.book_date)) tenor_in_months,
                      a.trn_ref_no,
                      decode(a.drcr_ind, 'C', a.lcy_amount, -lcy_amount) trans_amount,
                      a.ac_no account_no,
                      f.ac_gl_desc account_name,
                      a.user_id initiator_id,
                      d.user_name initiator_name,
                      a.auth_id authorizer_id,
                      a.trn_dt trans_date,
                      a.value_dt value_date,
                      a.fcy_amount,
                      a.exch_rate,
                      a.external_ref_no
        from acvw_all_ac_entries@fcubs_dr           a,
             sttm_cust_account@fcubs_dr             b,
             smtb_user@fcubs_dr                     d,
             dw_sttm_branch                   e,
             dw_sttb_account                  f,
             dw_cltm_product        g,
             sttm_customer@fcubs_dr                 h,
             fcubslive.sttm_cust_personal@fcubs_dr  i,
             fcubslive.cltb_account_master@fcubs_dr j
       where a.related_customer = b.cust_no(+)
         and b.cust_no = h.customer_no
         and h.customer_no = i.customer_no(+)
         and nvl(h.auth_stat, 'A') = 'A'
         and j.product_code = g.product_code(+)
         and a.related_customer = h.customer_no(+)
         and nvl(h.auth_stat, 'A') = 'A'
         and a.related_account = j.account_number(+)
         and a.ac_no = f.ac_gl_no(+)
         and a.ac_no = '245400027'
         and a.user_id = d.user_id
         and substr(a.trn_ref_no, 1, 3) = e.branch_code(+)
         and a.trn_dt between in_startdt and in_enddt;
  end;

  procedure star_reworked_items(in_startdt in date,
                                in_enddt   in date,
                                ret        out sys_refcursor) is
  begin
    open ret for
      select dd.emailaddress as dderralofficeremail,
             dd.firstname || ' ' || dd.surname as dderralofficername,
             intro.emailaddress as introducingofficeremail,
             intro.firstname || ' ' || intro.surname as introducingofficername,
             w.accountname,
             w.accountnumber,
             w.loaninterestrate,
             w.loanamount,
             w.datecreated,
             w.name as workflowid,
             t.groupcode,
             case
               when t.response = 1 then
                'Approved'
               when t.response = 2 then
                'Rejected'
               when t.response = 4 then
                'ReviewRequested'
               when t.response = 5 then
                'Checker Review Requested'
               when t.response = 6 then
                'Analyst Review Requested'
               when t.response = 7 then
                'Loan Team Review Requested'
               when t.response = 8 then
                'Represent To Reviewer'
               else
                'Unknown'
             end as taskresponse
        from str_workitems_new w
        left join str_users dd
          on w.referralofficerid = dd.id
        left join str_users intro
          on w.introducerofficerid = intro.id
        left join str_opstask t
          on w.id = t.workitemid
       where trunc(w.datecreated) between in_startdt and in_enddt;
  end;

procedure prc_insurance_fee(in_startdt in date,
                            in_enddt   in date,
                            ret        out sys_refcursor) is
begin
  open ret for
    select distinct substr(a.trn_ref_no, 1, 3) trans_branch,
                    e.branch_name trans_branch_name,
                    a.ac_branch acct_branch,
                    related_account,
                    a.related_customer customer_no,
                    nvl(h.customer_name1, ac_desc) customer_name,
                    j.book_date booking_date,
                    j.product_code,
                    g.product_desc product_description,
                    a.drcr_ind,
                    (select narration
                       from fcubslive.get_narration@fcubs_dr nn
                      where nn.trn_ref_no = a.trn_ref_no
                        and nn.ac_entry_sr_no = a.ac_entry_sr_no
                        and nn.trn_code = a.trn_code) narration,
                    j.maturity_date,
                    i.date_of_birth dat_of_birth,
                    nvl(i.telephone, i.mobile_number) customer_phone,
                    j.amount_disbursed loan_amount,
                    a.lcy_amount ins_fee,
                    case
                      when a.drcr_ind = 'C' then
                       round((a.lcy_amount / j.amount_disbursed) * 100, 2)
                    end premium_ratio,
                    round(months_between(j.maturity_date, j.book_date)) tenor_in_months,
                    a.trn_ref_no,
                    decode(a.drcr_ind, 'C', a.lcy_amount, -lcy_amount) trans_amount,
                    a.ac_no account_no,
                    f.ac_gl_desc account_name,
                    a.user_id initiator_id,
                    d.user_name initiator_name,
                    a.auth_id authorizer_id,
                    a.trn_dt trans_date,
                    a.value_dt value_date,
                    a.fcy_amount,
                    a.exch_rate,
                    a.external_ref_no
      from acvw_all_ac_entries@fcubs_dr           a,
           sttm_cust_account@fcubs_dr             b,
           smtb_user@fcubs_dr                     d,
           dw_sttm_branch                         e,
           dw_sttb_account                        f,
           dw_cltm_product                        g,
           sttm_customer@fcubs_dr                 h,
           fcubslive.sttm_cust_personal@fcubs_dr  i,
           fcubslive.cltb_account_master@fcubs_dr j,
           crm_clr_report_new                     k
     where a.related_customer = b.cust_no(+)
       and b.cust_no = h.customer_no
       and h.customer_no = i.customer_no(+)
       and nvl(h.auth_stat, 'A') = 'A'
       and j.product_code = g.product_code(+)
       and a.related_customer = h.customer_no(+)
       and nvl(h.auth_stat, 'A') = 'A'
       and j.product_code not in ('Z712',
                                  'Z740',
                                  'V747',
                                  'V717',
                                  'V711',
                                  'Z708',
                                  'V708',
                                  'V619',
                                  'V693',
                                  'Z741',
                                  'Z730',
                                  'ACF',
                                  'Z732',
                                  'Z739',
                                  'Z754',
                                  'V747')
       and e.record_stat = 'O'
       and a.related_account = j.account_number(+)
       and j.account_number = k.account_number
       and k.product <> 'MEM2'
          -----and nvl(j.auth_stat, 'A') = 'A'
          ----and nvl(j.account_status, 'A') = 'A'
       and a.ac_no = f.ac_gl_no(+)
       and a.ac_no = '245400027'
       and a.user_id = d.user_id
       and substr(a.trn_ref_no, 1, 3) = e.branch_code(+)
       and a.trn_dt between in_startdt and in_enddt;
end;
  procedure prc_cashbackedloan(in_account in varchar2,
                               ret        out sys_refcursor) is
    v_cust_no varchar2(9);
  begin
    select nvl(cust_no, '00000000')
      into v_cust_no
      from sttm_cust_account@fcubs_dr
     where cust_ac_no = trim(in_account);
    open ret for
    
      select a.customer_no,
             a.customer_name,
             a.tsa_accounts,
             b.account_number     cash_backed_loan,
             b.settlement_account,
             b.ccy,
             b.limit_acy          loan_amt,
             b.total_balance      loan_balance
        from (select customer_no,
                     customer_name,
                     rtrim(xmlagg(xmlelement(e, text, chr(10)).extract('//text()'))
                           .getclobval(),
                           ',') tsa_accounts
                from (select b.customer_no,
                             b.customer_name1 customer_name,
                             a.account_class || ' - ' || a.cust_ac_no ||
                             ' - ' || fn_get_acctstat(a.cust_ac_no) || ' - ' ||
                             'Bal.' || a.ccy || ' ' || a.acy_curr_balance text
                        from sttm_cust_account@fcubs_dr a,
                             sttm_customer@fcubs_dr     b
                       where a.cust_no = b.customer_no
                         and cust_no = v_cust_no
                         and a.account_class in ('SA_017',
                                                 'SA_019',
                                                 'SA_016',
                                                 'SA_020',
                                                 'SA_018',
                                                 'SA_015',
                                                 'SA_014',
                                                 'SA_022',
                                                 'SA_023',
                                                 'SA_024',
                                                 'SA_025'))
               group by customer_no, customer_name) a,
             crm_clr_report_new b
       where a.customer_no = b.cust_no(+)
         and b.product(+) in ('Z708', 'V708');
  
    /*      select a.customer_no,
          a.customer_name,
          a.tsa_accounts,
          b.account_number     cash_backed_loan,
          b.settlement_account,
          b.ccy,
          b.limit_acy          loan_amt,
          b.total_balance      loan_balance
     from (select b.customer_no,
                  b.customer_name1 customer_name,
                  listagg(a.account_class||' - '||a.cust_ac_no || ' - ' ||
                          fn_get_acctstat(a.cust_ac_no) || ' - ' || 'Bal.' ||
                          a.ccy || ' ' || a.acy_curr_balance,
                          chr(10)) within group(order by a.ac_open_date) tsa_accounts
             from sttm_cust_account@fcubs_dr a, sttm_customer@fcubs_dr b
            where a.cust_no = b.customer_no
              and cust_no = v_cust_no
              and a.account_class in ('SA_017',
                                      'SA_019',
                                      'SA_016',
                                      'SA_020',
                                      'SA_018',
                                      'SA_015',
                                      'SA_014',
                                      'SA_022',
                                      'SA_023',
                                      'SA_024',
                                      'SA_025')
            group by b.customer_no, b.customer_name1) a,
          crm_clr_report_new b
    where a.customer_no = b.cust_no(+)
      and b.product(+) = 'Z708';*/
  end;

  procedure prc_deposit_trackerv2(in_refdt in date, ret out sys_refcursor) is
  begin
    open ret for
      select distinct nvl(bb.department, 'BRANCH SERVICES') department,
                      nvl(bb.region, cc.region) region_name,
                      nvl(bb.zone_name, cc.zone_name) zone_name,
                      nvl(aa.branch_code, cc.new_branch_code) branch_code,
                      nvl(bb.branch_name, cc.branch_name) branch_name,
                      nvl(no_of_ac_opened, 0) no_of_ac_opened,
                      nvl(bb.base_lcy_bal, 0) base_lcy_bal,
                      nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
                      nvl(bb.mobilized_amt, 0) mobilized_amt,
                      nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt,
                      aa.target monthly_target,
                      nvl(aa.target, 0) *
                      to_number(to_char(in_refdt, 'MM')) current_target
        from (select department,
                     region,
                     zone_name,
                     branch_code,
                     branch_name,
                     count(cust_ac_no) no_of_ac_opened,
                     sum(base_lcy_bal) base_lcy_bal,
                     sum(curr_lcy_bal) curr_lcy_bal,
                     sum(mobilized_amt) mobilized_amt,
                     sum(avg_mobilized_amt) avg_mobilized_amt
                from (select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                            /* and to_char(b.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and a.reference_date = in_refdt
                      -- and (a.introducer_code = int_code or
                      --  int_code = 'ALL')
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             tmp_dep_td_contra_ac_opn_dt f*/
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                            --and a.cust_ac_no = f.cust_ac_no
                         and a.dep_cat = 'TIME'
                            /*and to_char(f.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                         and a.dep_cat = 'TIME'
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             d.staffname
                        from (select s.*, t.status_change_date
                                from services_tracker_all   s,
                                     services_tracker_drmnt t
                               where s.reference_date = t.reference_date
                                 and s.cust_ac_no = t.cust_ac_no
                                 and t.mobilized_amt > 0) a,
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and a.reference_date = in_refdt)
               group by department,
                        region,
                        zone_name,
                        branch_code,
                        branch_name) bb,
             dep_branch_targets aa,
             dw_ubn_brn_region cc
       where aa.branch_code = bb.branch_code(+)
         and aa.branch_code = cc.new_branch_code(+)
         and aa.branch_code != '000';
  
    /* select nvl(bb.department, 'BRANCH SERVICES') department,
          nvl(bb.region, cc.region) region_name,
          nvl(bb.zone_name, cc.zone_name) zone_name,
          nvl(bb.branch_code, cc.new_branch_code) branch_code,
          nvl(bb.branch_name, cc.branch_name) branch_name,
          nvl(bb.base_lcy_bal, 0) base_lcy_bal,
          nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
          nvl(bb.mobilized_amt, 0) mobilized_amt,
          nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt,
          aa.target monthly_target,
          aa.target * to_number(to_char(in_refdt, 'MM')) current_target
     from dep_branch_targets aa,
          (select b.department,
                  c.region,
                  c.zone_name,
                  c.new_branch_code branch_code,
                  c.branch_name,
                  \*nvl(b.staffno,a.introducer_code) introducer_code,
                  b.staffname introducer_name,*\
                  sum(a.base_lcy_bal) base_lcy_bal,
                  sum(a.curr_lcy_bal) curr_lcy_bal,
                  sum(a.mobilized_amt) mobilized_amt,
                  sum(a.avg_mobilized_amt) avg_mobilized_amt
             from services_tracker_all   a,
                  tab_operations_staff_2  b,
                  dw_ubn_brn_region c
            where a.introducer_code = b.staffno
              and b.branch_code(+) = c.new_branch_code
              and a.reference_date = in_refdt
            group by b.department,
                     c.region,
                     c.zone_name,
                     c.new_branch_code,
                     c.branch_name \*, nvl(b.staffno,a.introducer_code), b.staffname*\
           ) bb,
          ubn_brn_region cc
    where aa.branch_code = bb.branch_code(+)
      and aa.branch_code = cc.new_branch_code
      and cc.new_branch_code <> '000';*/
  end;
  procedure prc_deposit_trackerZn(in_refdt in date,
                                  in_zone  varchar2,
                                  ret      out sys_refcursor) is
  begin
    open ret for
      select distinct nvl(bb.department, 'BRANCH SERVICES') department,
                      nvl(bb.region, cc.region) region_name,
                      nvl(bb.zone_name, cc.zone_name) zone_name,
                      nvl(aa.branch_code, cc.new_branch_code) branch_code,
                      nvl(bb.branch_name, cc.branch_name) branch_name,
                      bb.introducer_code,
                      bb.staffname,
                      nvl(no_of_ac_opened, 0) no_of_ac_opened,
                      nvl(bb.base_lcy_bal, 0) base_lcy_bal,
                      nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
                      nvl(bb.mobilized_amt, 0) mobilized_amt,
                      nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt,
                      aa.target monthly_target,
                      nvl(aa.target, 0) *
                      to_number(to_char(in_refdt, 'MM')) current_target
        from (select department,
                     region,
                     zone_name,
                     branch_code,
                     branch_name,
                     staffname,
                     introducer_code,
                     count(cust_ac_no) no_of_ac_opened,
                     sum(base_lcy_bal) base_lcy_bal,
                     sum(curr_lcy_bal) curr_lcy_bal,
                     sum(mobilized_amt) mobilized_amt,
                     sum(avg_mobilized_amt) avg_mobilized_amt
                from (select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a,
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                            /* and to_char(b.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and a.reference_date = in_refdt
                         and c.zone_name = in_zone
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a,
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             tmp_dep_td_contra_ac_opn_dt f*/
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                            --and a.cust_ac_no = f.cust_ac_no
                         and a.dep_cat = 'TIME'
                            /*and to_char(f.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                         and d.zone_name = in_zone
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a,
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                         and c.zone_name = in_zone
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a,
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                         and a.dep_cat = 'TIME'
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                         and d.zone_name = in_zone
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             d.staffname
                        from (select s.*, t.status_change_date
                                from services_tracker_all   s,
                                     services_tracker_drmnt t
                               where s.reference_date = t.reference_date
                                 and s.cust_ac_no = t.cust_ac_no
                                 and t.mobilized_amt > 0) a,
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and a.reference_date = in_refdt
                         and c.zone_name = in_zone)
               group by department,
                        region,
                        zone_name,
                        branch_code,
                        branch_name,
                        introducer_code,
                        staffname) bb,
             dep_branch_targets aa,
             dw_ubn_brn_region cc
       where aa.branch_code = bb.branch_code(+)
         and aa.branch_code = cc.new_branch_code
         and aa.branch_code != '000';
  end;

  procedure prc_deposit_tracker_hq(in_refdt in date, ret out sys_refcursor) is
  begin
    open ret for
      select nvl(aa.department, 'HEAD OFFICE') department,
             aa.department region_name,
             nvl(bb.zone_name, 'HEAD OFFICE') zone_name,
             nvl(bb.branch_code, '000') branch_code,
             nvl(bb.branch_name, 'UBN HEAD OFFICE') branch_name,
             nvl(no_of_ac_opened, 0) no_of_ac_opened,
             nvl(bb.base_lcy_bal, 0) base_lcy_bal,
             nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
             nvl(bb.mobilized_amt, 0) mobilized_amt,
             nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt,
             aa.target monthly_target,
             aa.target /** to_number(to_char(in_refdt, 'MM'))*/ current_target
        from rep_hq_targets aa,
             (select department,
                     region,
                     zone_name,
                     branch_code,
                     branch_name,
                     count(cust_ac_no) no_of_ac_opened,
                     sum(base_lcy_bal) base_lcy_bal,
                     sum(curr_lcy_bal) curr_lcy_bal,
                     sum(mobilized_amt) mobilized_amt,
                     sum(avg_mobilized_amt) avg_mobilized_amt
                from (select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      -- and (a.introducer_code = int_code or
                      --  int_code = 'ALL')
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       tmp_dep_td_contra_ac_opn_dt f*/
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                            --  and a.cust_ac_no = f.cust_ac_no
                         and a.dep_cat = 'TIME'
                            /* and to_char(f.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      -- and (a.introducer_code = int_code or
                      --  int_code = 'ALL')
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                         and a.dep_cat = 'TIME'
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt)
               where branch_code = '000'
               group by department,
                        region,
                        zone_name,
                        branch_code,
                        branch_name) bb
       where aa.department = bb.department(+)
         and nvl(bb.mobilized_amt, 0) > 0;
  
    /*  select nvl(bb.department, 'HEAD OFFICE') department,
          nvl(bb.region_name, aa.department) region_name,
          nvl(bb.zone_name, 'HEAD OFFICE') zone_name,
          nvl(bb.branch_code, '000') branch_code,
          nvl(bb.branch_name, 'UBN HEAD OFFICE') branch_name,
          nvl(bb.base_lcy_bal, 0) base_lcy_bal,
          nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
          nvl(bb.mobilized_amt, 0) mobilized_amt,
          nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt,
          aa.target monthly_target,
          aa.target * to_number(to_char(in_refdt, 'MM')) current_target
     from rep_hq_targets aa,
          (select c.region department,
                  b.department region_name,
                  c.zone_name,
                  c.new_branch_code branch_code,
                  c.branch_name,
                  sum(a.base_lcy_bal) base_lcy_bal,
                  sum(a.curr_lcy_bal) curr_lcy_bal,
                  sum(a.mobilized_amt) mobilized_amt,
                  sum(a.avg_mobilized_amt) avg_mobilized_amt
             from services_tracker_all   a,
                  tab_operations_staff_2  b,
                  dw_ubn_brn_region c
            where a.introducer_code = b.staffno
              and b.branch_code(+) = c.new_branch_code
              and a.reference_date = in_refdt
              and b.branch_code = '000'
            group by b.department,
                     c.region,
                     c.zone_name,
                     c.new_branch_code,
                     c.branch_name) bb
    where aa.department = bb.region_name(+);*/
  end prc_deposit_tracker_hq;

  procedure prc_deposit_tracker_hq_dept(in_refdt      in date,
                                        in_department in varchar2,
                                        ret           out sys_refcursor) is
  begin
    open ret for
    /* select *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        from (select nvl(bb.department, 'HEAD OFFICE') department,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.region_name, aa.department) region_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.zone_name, 'HEAD OFFICE') zone_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.branch_code, '000') branch_code,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.branch_name, 'UBN HEAD OFFICE') branch_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     bb.staffno,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     bb.staffname,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.base_lcy_bal, 0) base_lcy_bal,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.mobilized_amt, 0) mobilized_amt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from rep_hq_targets aa,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (select c.region department,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b.department region_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             c.zone_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             c.new_branch_code branch_code,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             c.branch_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b.staffno,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b.staffname,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             sum(a.base_lcy_bal) base_lcy_bal,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             sum(a.curr_lcy_bal) curr_lcy_bal,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             sum(a.mobilized_amt) mobilized_amt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             sum(a.avg_mobilized_amt) avg_mobilized_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        from services_tracker_all   a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             tab_operations_staff_2  b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             dw_ubn_brn_region c
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       where a.introducer_code = b.staffno
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         and b.branch_code(+) = c.new_branch_code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         and a.reference_date = in_refdt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         and b.branch_code = '000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       group by b.department,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c.region,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c.zone_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c.new_branch_code,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c.branch_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                b.staffno,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                b.staffname) bb
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               where aa.department = bb.region_name(+))*/
      select nvl(bb.department, 'HEAD OFFICE') department,
             bb.department region_name,
             nvl(bb.zone_name, 'HEAD OFFICE') zone_name,
             nvl(bb.branch_code, '000') branch_code,
             nvl(bb.branch_name, 'UBN HEAD OFFICE') branch_name,
             introducer_code,
             staffname,
             nvl(no_of_ac_opened, 0) no_of_ac_opened,
             nvl(bb.base_lcy_bal, 0) base_lcy_bal,
             nvl(bb.curr_lcy_bal, 0) curr_lcy_bal,
             nvl(bb.mobilized_amt, 0) mobilized_amt,
             nvl(bb.avg_mobilized_amt, 0) avg_mobilized_amt
        from (select department,
                     region,
                     zone_name,
                     branch_code,
                     branch_name,
                     introducer_code,
                     staffname,
                     count(cust_ac_no) no_of_ac_opened,
                     sum(base_lcy_bal) base_lcy_bal,
                     sum(curr_lcy_bal) curr_lcy_bal,
                     sum(mobilized_amt) mobilized_amt,
                     sum(avg_mobilized_amt) avg_mobilized_amt
                from (select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      -- and (a.introducer_code = int_code or
                      --  int_code = 'ALL')
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 tmp_dep_td_contra_ac_opn_dt f*/
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                            -- and a.cust_ac_no = f.cust_ac_no
                         and a.dep_cat = 'TIME'
                            /* and to_char(f.ac_open_date, 'YYYY') =
                            to_char(trunc(sysdate), 'YYYY')*/
                         and to_char(a.reference_date, 'YYYY') =
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      union all
                      select d.department,
                             b.ac_desc,
                             c.region,
                             c.zone_name,
                             c.branch_name,
                             a.*,
                             b.ac_open_date,
                             d.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_cust_account@fcubs_dr b,
                             dw_ubn_brn_region c,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) d
                       where a.cust_ac_no = b.cust_ac_no
                         and a.branch_code = c.new_branch_code
                         and a.introducer_code = d.staffno
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt
                      -- and (a.introducer_code = int_code or
                      --  int_code = 'ALL')
                      union all
                      select e.department,
                             trim(nvl(b.full_name, customer_name1)),
                             d.region,
                             d.zone_name,
                             d.branch_name,
                             a.*,
                             c.book_date,
                             e.staffname
                        from services_tracker_all a, --services_tracker1 a, --
                             sttm_customer@fcubs_dr b,
                             cstb_contract@fcubs_dr c,
                             dw_ubn_brn_region d,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) e
                       where a.cust_no = b.customer_no
                         and a.cust_ac_no = c.contract_ref_no
                         and a.branch_code = d.new_branch_code
                         and a.introducer_code = e.staffno
                         and a.dep_cat = 'TIME'
                         and to_char(a.reference_date, 'YYYY') !=
                             to_char(trunc(sysdate), 'YYYY')
                         and a.reference_date = in_refdt)
               where branch_code = '000'
               group by department,
                        region,
                        zone_name,
                        branch_code,
                        branch_name,
                        introducer_code,
                        staffname) bb
       where bb.department = in_department
      --and nvl(bb.mobilized_amt, 0) > 0
      ;
  end;

  procedure prc_deposit_tracker_dtls(in_refdt in date,
                                     int_code in varchar2,
                                     ret      out sys_refcursor) is
  begin
    open ret for
      select distinct *
        from (select d.department,
                     b.ac_desc,
                     c.region,
                     c.zone_name,
                     c.branch_name,
                     a.*,
                     b.ac_open_date,
                     d.staffname
                from services_tracker_all a, --services_tracker1 a, --
                     finance.cust_tbl@finance b,
                     dw_ubn_brn_region c,
                     (select *
                        from tab_operations_staff_2
                       where staffno in
                             (select emp_number
                                from ubn_employee_details
                               where sbu = 'Service and Technology')) d
               where a.cust_ac_no = b.cust_ac_no
                 and a.branch_code = c.new_branch_code
                 and a.introducer_code = d.staffno
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                    /* and to_char(b.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                    -- and a.mobilized_amt > 0
                 and a.reference_date = in_refdt
                 and (a.introducer_code = int_code or int_code = 'ALL')
              union all
              select e.department,
                     trim(nvl(b.full_name, customer_name1)),
                     d.region,
                     d.zone_name,
                     d.branch_name,
                     a.*,
                     --c.book_date,
                     c.value_date,
                     e.staffname
                from services_tracker_all   a, --services_tracker1 a, --
                     sttm_customer@fcubs_dr b,
                     --cstb_contract@fcubs_dr c,
                     ldtb_contract_master@fcubs_dr c,
                     dw_ubn_brn_region d,
                     (select *
                        from tab_operations_staff_2
                       where staffno in
                             (select emp_number
                                from ubn_employee_details
                               where sbu = 'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           tmp_dep_td_contra_ac_opn_dt f*/
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.branch_code = d.new_branch_code
                 and a.introducer_code = e.staffno
                    --and a.cust_ac_no = f.cust_ac_no
                 and a.dep_cat = 'TIME'
                    /*and to_char(f.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and (a.introducer_code = int_code or int_code = 'ALL')
              union all
              select d.department,
                     b.ac_desc,
                     c.region,
                     c.zone_name,
                     c.branch_name,
                     a.*,
                     b.ac_open_date,
                     d.staffname
                from services_tracker_all a, --services_tracker1 a, --
                     finance.cust_tbl@finance b,
                     dw_ubn_brn_region c,
                     (select *
                        from tab_operations_staff_2
                       where staffno in
                             (select emp_number
                                from ubn_employee_details
                               where sbu = 'Service and Technology')) d
               where a.cust_ac_no = b.cust_ac_no
                 and a.branch_code = c.new_branch_code
                 and a.introducer_code = d.staffno
                 and to_char(a.reference_date, 'YYYY') !=
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and (a.introducer_code = int_code or int_code = 'ALL')
              union all
              select e.department,
                     trim(nvl(b.full_name, customer_name1)),
                     d.region,
                     d.zone_name,
                     d.branch_name,
                     a.*,
                     --c.book_date,
                     c.value_date,
                     e.staffname
                from services_tracker_all   a, --services_tracker1 a, --
                     sttm_customer@fcubs_dr b,
                     --cstb_contract@fcubs_dr c,
                     ldtb_contract_master@fcubs_dr c,
                     dw_ubn_brn_region d,
                     (select *
                        from tab_operations_staff_2
                       where staffno in
                             (select emp_number
                                from ubn_employee_details
                               where sbu = 'Service and Technology')) e
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.branch_code = d.new_branch_code
                 and a.introducer_code = e.staffno
                 and a.dep_cat = 'TIME'
                 and to_char(a.reference_date, 'YYYY') !=
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and (a.introducer_code = int_code or int_code = 'ALL')
              union all
              select d.department,
                     b.ac_desc,
                     c.region,
                     c.zone_name,
                     c.branch_name,
                     a.*,
                     d.staffname
                from (select s.*, t.status_change_date
                        from services_tracker_all s, services_tracker_drmnt t
                       where s.reference_date = t.reference_date
                         and s.cust_ac_no = t.cust_ac_no
                         and t.mobilized_amt > 0) a,
                     finance.cust_tbl@finance b,
                     dw_ubn_brn_region c,
                     (select *
                        from tab_operations_staff_2
                       where staffno in
                             (select emp_number
                                from ubn_employee_details
                               where sbu = 'Service and Technology')) d
               where a.cust_ac_no = b.cust_ac_no
                 and a.branch_code = c.new_branch_code
                 and a.introducer_code = d.staffno
                 and a.reference_date = in_refdt
                 and (a.introducer_code = int_code or int_code = 'ALL'));
    /*  select b.ac_desc,
           c.region,
           c.zone_name,
           c.branch_name,
           a.*,
           b.ac_open_date,
           d.full_name
      from services_tracker_all      a,
           sttm_cust_account@fcubs_dr b,
           dw_ubn_brn_region    c,
           ubn_employee_details       d
     where a.cust_ac_no = b.cust_ac_no
       and a.branch_code = c.new_branch_code
       and a.introducer_code = d.emp_number
       and a.reference_date = in_refdt
       and (a.introducer_code = int_code or int_code = 'ALL')
    union all
    select trim(nvl(b.full_name, customer_name1)),
           d.region,
           d.zone_name,
           d.branch_name,
           a.*,
           c.book_date,
           e.full_name
      from services_tracker_all   a,
           sttm_customer@fcubs_dr  b,
           cstb_contract@fcubs_dr  c,
           dw_ubn_brn_region d,
           ubn_employee_details    e
     where a.cust_no = b.customer_no
       and a.cust_ac_no = c.contract_ref_no
       and a.branch_code = d.new_branch_code
       and a.introducer_code = e.emp_number
       and a.dep_cat = 'TIME'
       and a.reference_date = in_refdt
       and (a.introducer_code = int_code or int_code = 'ALL')
    union all
    select b.ac_desc,
           c.region,
           c.zone_name,
           c.branch_name,
           a.*,
           d.full_name
      from (select s.*, t.status_change_date
              from services_tracker_all s, services_tracker_drmnt t
             where s.reference_date = t.reference_date
               and s.cust_ac_no = t.cust_ac_no
               and t.mobilized_amt > 0) a,
           sttm_cust_account@fcubs_dr b,
           dw_ubn_brn_region c,
           ubn_employee_details d
     where a.cust_ac_no = b.cust_ac_no
       and a.branch_code = c.new_branch_code
       and a.introducer_code = d.emp_number
       and a.reference_date = in_refdt
       and (a.introducer_code = int_code or int_code = 'ALL');*/
  end;

  procedure prc_treasury_bill_hold(ret out sys_refcursor) is
  begin
    open ret for
      select reference_num,
             customer_name,
             customer_id,
             request_type,
             acct_num,
             brn_name,
             customer_email,
             amnt_face_value,
             tenor,
             request_date,
             maturity_date,
             value_date,
             initiator_email,
             relatnship_mgr,
             rm_code,
             request_status,
             hold_date,
             interest,
             discounted_amount,
             commission,
             custody_fee,
             vat_commission,
             vat_custody_fee,
             amount_held,
             treasury_sales_status,
             maker_branch,
             maker_branch_timestamp,
             checker_branch,
             checker_branch_timestamp,
             maker_tsales,
             maker_tsales_timestamp,
             checker_tsales,
             checker_tsales_timestamp,
             maker_trops,
             maker_trops_timestamp,
             checker_trops,
             checker_trops_timestamp,
             hold_ref_num_removehold,
             response_code_removehold,
             response_message_removehold,
             rate
        from tbillusr.treasury_bills_req@contactme
       where request_status = 'REMOVING_HOLD';
  end prc_treasury_bill_hold;

  procedure prc_loan_acct_wrg_autostatus(ret out sys_refcursor) is
  begin
    open ret for
      select chk.branch_code,
             chk.new_ac_no,
             chk.old_ac_no,
             chk.cust_no,
             chk.customer,
             chk.product_code,
             chk.amount_financed,
             chk.value_date,
             chk.maturity_date,
             chk.status_change_mode,
             chk."SETTLEMENT ACCT",
             chk."PRINCIPAL BALANCE LCY",
             chk."INTEREST ARREARS",
             chk."OTHER INTEREST ARREARS",
             chk."PRINCIPAL ARREARS",
             chk."TOTAL BALANCE",
             chk."TOTAL AMT PAST DUE",
             chk."TOTAL DAYS PAST DUE",
             chk.sysclass,
             chk.expclass,
             chk.source
        from (select *
                from (select a.branch_code,
                             a.account_number new_ac_no,
                             a.alt_acc_no old_ac_no,
                             a.customer_id cust_no,
                             a.primary_applicant_name customer,
                             a.product_code,
                             a.amount_financed,
                             a.value_date,
                             a.maturity_date,
                             a.status_change_mode,
                             a.dr_prod_ac "SETTLEMENT ACCT",
                             (nvl(qa.princbal, 0) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate))) "PRINCIPAL BALANCE LCY",
                             (nvl(dd.int_arr, 0) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate))) "INTEREST ARREARS",
                             (nvl(qq.pnlint_arr, 0) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate))) "OTHER INTEREST ARREARS",
                             (nvl(nn.princ_arr, 0) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate))) "PRINCIPAL ARREARS",
                             (nvl(qa.princbal, 0) + nvl(dd.int_arr, 0) +
                             nvl(qq.pnlint_arr, 0)) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate)) "TOTAL BALANCE",
                             (nvl(nn.princ_arr, 0) + nvl(dd.int_arr, 0) +
                             nvl(qq.pnlint_arr, 0)) *
                             (decode(a.currency, 'NGN', 1, x.mid_rate)) "TOTAL AMT PAST DUE",
                             round(((sysdate) - earldue), 0) "TOTAL DAYS PAST DUE",
                             decode(a.user_defined_status,
                                    'NORM',
                                    'PERFORMING',
                                    'WTL1',
                                    'WATCHLIST1',
                                    'WTL2',
                                    'WATCHLIST2',
                                    'WTL3',
                                    'WATCHLIST3',
                                    'SUBS',
                                    'SUBSTANDARD',
                                    'DOUB',
                                    'DOUBTFUL',
                                    'LOSS',
                                    'LOST',
                                    'WOFF',
                                    'WRITE-OFF') sysclass,
                             (case
                               when round(((sysdate) - earldue), 0) < '8' then
                                'PERFORMING'
                               when round(((sysdate) - earldue), 0) between '8' and '29' then
                                'WATCHLIST1'
                               when round(((sysdate) - earldue), 0) between '30' and '59' then
                                'WATCHLIST2'
                               when round(((sysdate) - earldue), 0) between '60' and '89' then
                                'WATCHLIST3'
                               when round(((sysdate) - earldue), 0) between '90' and
                                    '179' then
                                'SUBSTANDARD'
                               when round(((sysdate) - earldue), 0) between
                                    '180' and '359' then
                                'DOUBTFUL'
                               when round(((sysdate) - earldue), 0) > '360' then
                                'LOST'
                               else
                                'NO RATING'
                             end) expclass,
                             'CL' source
                        from fcubslive.cltb_account_master@fcubs_dr a
                        left join (select ccy1, mid_rate
                                    from fcubslive.cytm_rates@fcubs_dr
                                   where branch_code = '000'
                                     and ccy2 = 'NGN'
                                     and rate_type = 'STANDARD'
                                     and rate_date <= (sysdate)) x
                          on a.currency = x.ccy1,
                       (select account_number acct,
                                     min(schedule_due_date) earldue
                                from fcubslive.cltb_account_schedules@fcubs_dr
                               where component_name in
                                     ('PRINCIPAL',
                                      'MAIN_INT',
                                      'ODIN_PNLTY',
                                      'ODPR_PNLTY')
                                 and schedule_due_date <= (sysdate)
                                 and (nvl(amount_due, 0) -
                                     nvl(amount_settled, 0)) > 0
                               group by account_number) b
                        left join (select account_number,
                                         sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) princ_arr
                                    from fcubslive.cltb_account_schedules@fcubs_dr
                                   where component_name = 'PRINCIPAL'
                                     and schedule_due_date <= (sysdate)
                                   having
                                   sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) > 0
                                   group by account_number) nn
                          on b.acct = nn.account_number
                        left join (select account_number,
                                         sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) int_arr
                                    from fcubslive.cltb_account_schedules@fcubs_dr
                                   where component_name = 'MAIN_INT'
                                     and schedule_due_date <= (sysdate)
                                   having
                                   sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) > 0
                                   group by account_number) dd
                          on b.acct = dd.account_number
                        left join (select account_number,
                                         sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) pnlint_arr
                                    from fcubslive.cltb_account_schedules@fcubs_dr
                                   where component_name in
                                         ('ODIN_PNLTY', 'ODPR_PNLTY')
                                     and schedule_due_date <= (sysdate)
                                   having
                                   sum(nvl(amount_due, 0) -
                                             nvl(amount_settled, 0)) > 0
                                   group by account_number) qq
                          on b.acct = qq.account_number,
                       dw_cltm_product dd,
                       (select account_number,
                                     sum(nvl(amount_due, 0) -
                                         nvl(amount_settled, 0)) princbal
                                from fcubslive.cltb_account_schedules@fcubs_dr
                               where component_name = 'PRINCIPAL' having
                               sum(nvl(amount_due, 0) -
                                         nvl(amount_settled, 0)) > 0
                               group by account_number) qa
                       where a.account_number = b.acct
                         and a.account_status = 'A'
                         and a.product_code = dd.product_code
                         and a.status_change_mode = 'A'
                         and qa.account_number = a.account_number)
               where sysclass <> expclass) chk;
  end prc_loan_acct_wrg_autostatus;
  procedure prc_sv_cur_acct_indebit(ret out sys_refcursor) is
  begin
    open ret for
      select sd.branch_code,
             sd.cust_ac_no,
             sd.ccy,
             sd.account_class,
             sd.ac_desc,
             sd.record_stat,
             sd.acy_avl_bal,
             sd.lcy_curr_balance,
             sd.overdraft_since,
             sd.overline_od_since
        from (select branch_code,
                     cust_ac_no,
                     ccy,
                     account_class,
                     ac_desc,
                     record_stat,
                     acy_avl_bal,
                     lcy_curr_balance,
                     overdraft_since,
                     overline_od_since
                from fcubslive.sttm_cust_account@fcubs_dr
               where account_type = 'S'
                 and acy_avl_bal < 0
                 and (overdraft_since =
                     (select prev_working_day
                         from sttm_dates@fcubs_dr
                        where branch_code = '000') or
                     overline_od_since =
                     (select today
                         from sttm_dates@fcubs_dr
                        where branch_code = '000'))
              
              ) sd;
  end prc_sv_cur_acct_indebit;
  procedure prc_manual_ent_prod_gl_casa(ret out sys_refcursor) is
  begin
    open ret for
      select trn_ref_no,
             ac_branch,
             ac_no,
             ac_ccy,
             drcr_ind,
             fcy_amount,
             lcy_amount,
             exch_rate,
             trn_dt,
             value_dt,
             module,
             batch_no,
             user_id,
             auth_id,
             fcubslive.bipks_ubn.fn_get_narration@fcubs_dr(module,
                                                           trn_ref_no,
                                                           ac_entry_sr_no,
                                                           event_sr_no,
                                                           trn_code,
                                                           related_account) narration
        from fcubslive.acvw_all_ac_entries@fcubs_dr
       where trn_dt >= (select prev_working_day
                          from sttm_dates@fcubs_dr
                         where branch_code = '000')
         and trn_dt <= (select today
                          from sttm_dates@fcubs_dr
                         where branch_code = '000')
         and ac_no in (select distinct account_head
                         from fcubslive.cstm_product_accrole@fcubs_dr
                        where product_code in
                              (select product_code
                                 from fcubslive.cstm_product@fcubs_dr
                                where module = 'LD'
                                  and product_type = 'D')
                          and accounting_role like '%PAY'
                          and accounting_role not like '%WHT%')
         and module not in ('CL', 'MM', 'RE', 'SD', 'SP', 'LD')
         and user_id not in ('SYSTEM', 'MIGUSER');
  end prc_manual_ent_prod_gl_casa;
  procedure prc_loan_rate_plr(ret out sys_refcursor) is
  begin
    open ret for
      select a.branch_code brn,
             upper(c.branch_name) brn_name,
             a.account_number account_number,
             a.primary_applicant_name customer_name,
             a.product_code product,
             d.product_desc product_name,
             a.currency ccy,
             a.amount_financed txn_amount_acy,
             a.value_date,
             a.maturity_date,
             cc.resolval intrate,
             a.dr_prod_ac settlement_account,
             nvl(hh.princbal, 0) principal_balance_acy,
             (nvl(hh.princbal, 0) *
             (decode(a.currency, 'NGN', 1, x.mid_rate))) principal_balance_lcy,
             t.account_head reporting_gl
        from fcubslive.cltb_account_master@fcubs_dr a
        left join (select ccy1, mid_rate
                     from fcubslive.cytm_rates@fcubs_dr
                    where branch_code = '000'
                      and ccy2 = 'NGN'
                      and rate_type = 'STANDARD'
                      and rate_date <=
                          (select today
                             from fcubslive.sttm_dates@fcubs_dr
                            where branch_code = '000')) x
          on a.currency = x.ccy1
        left join (select account_number,
                          sum(amount_due) - sum(amount_settled) princbal
                     from fcubslive.cltb_account_schedules@fcubs_dr
                    where component_name = 'PRINCIPAL' having
                    sum(amount_due) - sum(amount_settled) > 0
                    group by account_number) hh
          on a.account_number = hh.account_number,
       dw_sttm_branch c,
       dw_cltm_product d,
       fcubslive.cltm_product_rth@fcubs_dr t,
       fcubslive.clvw_udevals@fcubs_dr cc
       where a.branch_code = c.branch_code
         and a.product_code = d.product_code
         and a.account_number = cc.accno
         and cc.effdt = (select max(effdt)
                           from fcubslive.clvw_udevals@fcubs_dr
                          where accno = cc.accno
                            and udeid = 'INTEREST_RATE')
         and cc.udeid = 'INTEREST_RATE'
         and t.accounting_role = 'LOAN_ACCOUNT'
         and a.product_code = t.product_code
         and a.product_code = t.product_code
         and a.account_status = 'A'
         and a.book_date = (select prev_working_day
                              from fcubslive.sttm_dates@fcubs_dr
                             where branch_code = '000')
         and cc.resolval < '26.5';
  
  end prc_loan_rate_plr;
  procedure prc_curr_acct_with_credit_int(ret out sys_refcursor) is
  begin
    open ret for
      select distinct c.branch_code,
                      cust_ac_no,
                      ac_desc,
                      account_class,
                      prod,
                      ccy,
                      b.rate base_rate,
                      a.ude_value spread,
                      (b.rate + a.ude_value) interest_rate --, a.*
        from fcubslive.ictm_acc_udevals@fcubs_dr  a,
             fcubslive.ictm_rates@fcubs_dr        b,
             fcubslive.sttm_cust_account@fcubs_dr c
       where acc in (select cust_ac_no
                       from fcubslive.sttm_cust_account@fcubs_dr
                      where record_stat = 'O'
                        and account_type = 'S')
         and ude_id = 'INTEREST_RATE'
         and a.rate_code = b.rate_code
         and a.acc = c.cust_ac_no
         and b.record_stat = 'O'
         and (b.rate + a.ude_value) > 3.9;
  
  end prc_curr_acct_with_credit_int;

  procedure prc_ficticiously_liquidated_td(ret out sys_refcursor) is
  begin
    open ret for
      select b.contract_ref_no,
             b.customer_name1 customer_name,
             a.ac_ccy ccy,
             b.start_date,
             b.amount,
             b.value_date,
             b.maturity_date,
             b.contract_status,
             sum(decode(drcr_ind, 'D', -fcy_amount, fcy_amount)) fictitious_amount_liquidated,
             ac_no gl_debited,
             b.dflt_settle_ac account_credited,
             max(trn_dt) date_liquidated
        from fcubslive.acvw_all_ac_entries@fcubs_dr a,
             (select contract_ref_no,
                     (original_start_date) start_date,
                     amount,
                     value_date,
                     maturity_date,
                     contract_status,
                     customer_name1,
                     c.dflt_settle_ac
                from fcubslive.ldtb_contract_master@fcubs_dr c
                left join fcubslive.sttm_customer@fcubs_dr e
                  on e.customer_no = c.counterparty
               where module in ('MM', 'LD')
                 and c.version_no =
                     (select max(version_no)
                        from fcubslive.ldtb_contract_master@fcubs_dr
                       where contract_ref_no = c.contract_ref_no)) b
       where a.ac_no in ('210330010',
                         '210430012',
                         '210410005',
                         '210430008',
                         '210410004',
                         '210410008',
                         '210430013',
                         '210410007')
         and ac_ccy != 'NGN'
         and a.trn_ref_no = b.contract_ref_no having
       sum(decode(drcr_ind, 'D', -fcy_amount, fcy_amount)) < '0'
       group by b.contract_ref_no,
                b.customer_name1,
                a.ac_ccy,
                b.start_date,
                b.amount,
                b.value_date,
                b.maturity_date,
                b.contract_status,
                ac_no,
                b.dflt_settle_ac
      union
      select b.contract_ref_no,
             b.customer_name1 "CUSTOMER NAME",
             a.ac_ccy ccy,
             b.start_date,
             b.amount,
             b.value_date,
             b.maturity_date,
             b.contract_status,
             sum(decode(drcr_ind, 'D', -lcy_amount, lcy_amount)),
             ac_no,
             b.dflt_settle_ac,
             max(trn_dt)
        from fcubslive.acvw_all_ac_entries@fcubs_dr a,
             (select contract_ref_no,
                     (original_start_date) start_date,
                     amount,
                     value_date,
                     maturity_date,
                     contract_status,
                     customer_name1,
                     c.dflt_settle_ac
                from fcubslive.ldtb_contract_master@fcubs_dr c
                left join fcubslive.sttm_customer@fcubs_dr e
                  on e.customer_no = c.counterparty
               where module in ('MM', 'LD')
                 and c.version_no =
                     (select max(version_no)
                        from fcubslive.ldtb_contract_master@fcubs_dr
                       where contract_ref_no = c.contract_ref_no)) b
       where a.ac_no in ('210330010',
                         '210430012',
                         '210410005',
                         '210430008',
                         '210410004',
                         '210410008',
                         '210430013',
                         '210410007')
         and ac_ccy = 'NGN'
         and a.trn_ref_no = b.contract_ref_no having
       sum(decode(drcr_ind, 'D', -lcy_amount, lcy_amount)) < '0'
       group by b.contract_ref_no,
                b.customer_name1,
                a.ac_ccy,
                b.start_date,
                b.amount,
                b.value_date,
                b.maturity_date,
                b.contract_status,
                ac_no,
                b.dflt_settle_ac;
  end prc_ficticiously_liquidated_td;
  procedure prc_td_with_rate(ret out sys_refcursor) is
  begin
    open ret for
      select h.branch_code brn,
             upper(h.branch_name) brn_name,
             a.contract_ref_no account_number,
             e.customer_name1 customer_name,
             q.product_code product,
             u.product_description product_name,
             a.currency ccy,
             (a.amount) txn_amount_acy,
             a.booking_date,
             a.value_date,
             a.maturity_date,
             a.dflt_settle_ac settlement_account,
             (g.principal_outstanding_bal) principal_balance_acy,
             (g.principal_outstanding_bal *
             (decode(a.currency, 'NGN', 1, x.mid_rate))) principal_balance_lcy,
             t.account_head cr_gl,
             a.main_comp_rate
        from fcubslive.ldtb_contract_master@fcubs_dr a
        left join (select ccy1, mid_rate
                     from fcubslive.cytm_rates@fcubs_dr
                    where branch_code = '000'
                      and ccy2 = 'NGN'
                      and rate_type = 'STANDARD'
                      and rate_date <
                          (select today
                             from fcubslive.sttm_dates@fcubs_dr
                            where branch_code = '000')) x
          on a.currency = x.ccy1, fcubslive.sttm_customer@fcubs_dr e,
       fcubslive.cstm_product@fcubs_dr u,
       fcubslive.cstb_contract@fcubs_dr q,
       fcubslive.ldtbs_contract_balance@fcubs_dr g,
       dw_sttm_branch h,
       fcubslive.cstm_product_accrole@fcubs_dr t
       where a.contract_ref_no = q.contract_ref_no
         and q.latest_version_no = a.version_no
         and a.counterparty = e.customer_no
         and a.product = u.product_code
         and a.contract_ref_no = g.contract_ref_no
         and a.contract_status = 'A'
         and g.principal_outstanding_bal > 0.00
         and h.branch_code = q.branch
         and t.accounting_role = 'LIABGL'
         and q.product_code = t.product_code
         and a.booking_date = (select prev_working_day
                                 from fcubslive.sttm_dates@fcubs_dr
                                where branch_code = '000')
         and t.account_head in ('210430012',
                                '210410008',
                                '210430013',
                                '210430008',
                                '210410005',
                                '210410004',
                                '210330010');
  end prc_td_with_rate;
  procedure prc_unclaimed_td_casa_gl(ret out sys_refcursor) is
  begin
    open ret for
      select trn_ref_no,
             ac_branch,
             ac_no,
             ac_ccy,
             drcr_ind,
             fcy_amount,
             lcy_amount,
             exch_rate,
             trn_dt,
             value_dt,
             module,
             batch_no,
             user_id,
             auth_id,
             fcubslive.bipks_ubn.fn_get_narration@fcubs_dr(module,
                                                           trn_ref_no,
                                                           ac_entry_sr_no,
                                                           event_sr_no,
                                                           trn_code,
                                                           related_account) narration
        from fcubslive.acvw_all_ac_entries@fcubs_dr
       where trn_dt = (select prev_working_day
                         from fcubslive.sttm_dates@fcubs_dr
                        where branch_code = '000')
         and ac_no in ('140230024',
                       '210130021',
                       '210210024',
                       '210210025',
                       '210210027',
                       '210330004',
                       '210330005',
                       '210430005',
                       '210430015',
                       '245320021')
         and module not in ('CL', 'MM', 'RE', 'SD', 'SP')
         and user_id not in ('SYSTEM', 'MIGUSER');
  end prc_unclaimed_td_casa_gl;
  procedure prc_od_no_ic(ret out sys_refcursor) is
  begin
    open ret for
      select branch_code,
             cust_ac_no,
             customer_no,
             aa.limit_amount line,
             aa.line_start_date,
             aa.line_expiry_date,
             s.linked_ref_no,
             effective_date line_link_eff_date,
             (select min(ude_eff_dt)
                from fcubslive.ictm_acc_udevals@fcubs_dr
               where acc = s.cust_ac_no
                 and ude_eff_dt >= s.effective_date) int_eff_date
        from fcubslive.sttm_cust_account_linkages@fcubs_dr s,
             fcubslive.getm_facility@fcubs_dr              aa,
             dw_getm_liab                  bb
       where s.linked_ref_no = aa.line_code || aa.line_serial
         and s.customer_no = bb.liab_no
         and bb.id = aa.liab_id
         and s.effective_date =
             (select prev_working_day
                from fcubslive.sttm_dates@fcubs_dr
               where branch_code = '000')
         and effective_date <>
             (select min(ude_eff_dt)
                from fcubslive.ictm_acc_udevals@fcubs_dr
               where acc = s.cust_ac_no
                 and ude_eff_dt >= s.effective_date)
         and s.effective_date not in
             (select ude_eff_dt
                from fcubslive.ictm_acc_udevals@fcubs_dr
               where acc = s.cust_ac_no);
  end prc_od_no_ic;
  procedure prc_entries_settl_bridge_gl(ret out sys_refcursor) is
  begin
    open ret for
      select trn_ref_no,
             ac_branch,
             ac_no,
             ac_ccy,
             drcr_ind,
             fcy_amount,
             lcy_amount,
             exch_rate,
             trn_dt,
             value_dt,
             module,
             batch_no,
             user_id,
             auth_id,
             fcubslive.bipks_ubn.fn_get_narration@fcubs_dr(module,
                                                           trn_ref_no,
                                                           ac_entry_sr_no,
                                                           event_sr_no,
                                                           trn_code,
                                                           related_account) narration
        from fcubslive.acvw_all_ac_entries@fcubs_dr
       where trn_dt = (select prev_working_day
                         from fcubslive.sttm_dates@fcubs_dr
                        where branch_code = '000')
         and ac_no in ('140130042', '250910004');
  end prc_entries_settl_bridge_gl;
  procedure prc_revaluation(ret out sys_refcursor) is
  begin
    open ret for
      select a.branch_code,
             a.reval_date,
             a.ccy,
             a.reval_ind,
             a.account,
             a.account_balance,
             b.cust_no,
             nvl(b.ac_gl_desc, b.cust_name1) acct_name,
             a.old_lcy_equivalent,
             a.new_lcy_equivalent,
             a.new_rate,
             round(decode(old_lcy_equivalent, 0, 1, old_lcy_equivalent) /
                   decode(account_balance, 0, 1, account_balance),
                   2) wac_rate,
             a.reval_account,
             a.pnl_account,
             (a.old_lcy_equivalent - a.new_lcy_equivalent) pnl_amount
        from fcubslive.rvtb_acc_reval@fcubs_dr a, dw_sttb_account b
       where a.reval_account = b.ac_gl_no(+)
         and reval_date = (select prev_working_day
                             from sttm_dates@fcubs_dr
                            where branch_code = '000')
      -----and substr(reval_account,1,1)  in ('3','5','6') ---and length(reval_account)<>9
       order by 1, account, ccy;
  
  end prc_revaluation;

  procedure prc_global_deposit_tracker(in_refdt in date,
                                       ret      out sys_refcursor) is
  
  begin
  
    open ret for
    
      select *
        from (select 'BRANCHES' department,
                     bb.base_lcy_bal,
                     bb.curr_lcy_bal,
                     aa.current_target target,
                     bb.mobilized_amt,
                     bb.avg_mobilized_amt
                from (select round(sum(target) * 12) current_target
                        from dep_branch_targets) aa,
                     (select sum(base_lcy_bal) base_lcy_bal,
                             sum(curr_lcy_bal) curr_lcy_bal,
                             sum(mobilized_amt) mobilized_amt,
                             sum(avg_mobilized_amt) avg_mobilized_amt
                        from (select /*b.department,*/
                               sum(a.base_lcy_bal) base_lcy_bal,
                               sum(a.curr_lcy_bal) curr_lcy_bal,
                               sum(a.mobilized_amt) mobilized_amt,
                               sum(a.avg_mobilized_amt) avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code <> '000'
                              union all
                              select /*b.department,*/
                               sum(a.base_lcy_bal) base_lcy_bal,
                               sum(a.curr_lcy_bal) curr_lcy_bal,
                               sum(a.mobilized_amt) mobilized_amt,
                               sum(a.avg_mobilized_amt) avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   tmp_dep_td_contra_ac_opn_dt f*/
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                    --and a.cust_ac_no = f.cust_ac_no
                                 and a.dep_cat = 'TIME'
                                    /* and to_char(f.ac_open_date, 'YYYY') =
                                    to_char(trunc(sysdate), 'YYYY')*/
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code <> '000')
                      /*group by b.department*/
                      ) bb
              union all
              select bb.department,
                     nvl(aa.base_lcy_bal, 0),
                     nvl(aa.curr_lcy_bal, 0),
                     nvl(bb.target, 0),
                     nvl(aa.mobilized_amt, 0),
                     nvl(aa.avg_mobilized_amt, 0)
                from (select department,
                             sum(base_lcy_bal) base_lcy_bal,
                             sum(curr_lcy_bal) curr_lcy_bal,
                             sum(mobilized_amt) mobilized_amt,
                             sum(avg_mobilized_amt) avg_mobilized_amt
                        from (select trim(d.department) department,
                                     sum(a.base_lcy_bal) base_lcy_bal,
                                     sum(a.curr_lcy_bal) curr_lcy_bal,
                                     sum(a.mobilized_amt) mobilized_amt,
                                     sum(a.avg_mobilized_amt) avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code = '000'
                               group by trim(d.department)
                              union all
                              select trim(e.department) department,
                                     sum(a.base_lcy_bal) base_lcy_bal,
                                     sum(a.curr_lcy_bal) curr_lcy_bal,
                                     sum(a.mobilized_amt) mobilized_amt,
                                     sum(a.avg_mobilized_amt) avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   tmp_dep_td_contra_ac_opn_dt f*/
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                    -- and a.cust_ac_no = f.cust_ac_no
                                 and a.dep_cat = 'TIME'
                                    /* and to_char(f.ac_open_date, 'YYYY') =
                                    to_char(trunc(sysdate), 'YYYY')*/
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code = '000'
                               group by trim(e.department))
                       group by department) aa,
                     rep_hq_targets bb
               where aa.department(+) = bb.department);
    -----before 07feb2019
    /*      select *
      from (select 'BRANCHES' department,
                   bb.base_lcy_bal,
                   bb.curr_lcy_bal,
                   aa.current_target target,
                   bb.mobilized_amt,
                   bb.avg_mobilized_amt
              from (select round(sum(target) *
                                 to_number(to_char(in_refdt, 'MM'))) current_target
                      from dep_branch_targets) aa,
                   (select \*b.department,*\
                     sum(a.base_lcy_bal) base_lcy_bal,
                     sum(a.curr_lcy_bal) curr_lcy_bal,
                     sum(a.mobilized_amt) mobilized_amt,
                     sum(a.avg_mobilized_amt) avg_mobilized_amt
                      from services_tracker_all   a,
                           tab_operations_staff_2  b,
                           dw_ubn_brn_region c
                     where a.introducer_code = b.staffno
                       and b.branch_code(+) = c.new_branch_code
                       and a.reference_date = in_refdt
                       and c.new_branch_code <> '000'
                    \*group by b.department*\
                    ) bb
            union all
            select bb.department,
                   nvl(aa.base_lcy_bal, 0),
                   nvl(aa.curr_lcy_bal, 0),
                   nvl(bb.target, 0),
                   nvl(aa.mobilized_amt, 0),
                   nvl(aa.avg_mobilized_amt, 0)
              from (select trim(b.department) department,
                           sum(a.base_lcy_bal) base_lcy_bal,
                           sum(a.curr_lcy_bal) curr_lcy_bal,
                           sum(a.mobilized_amt) mobilized_amt,
                           sum(a.avg_mobilized_amt) avg_mobilized_amt
                      from services_tracker_all             a,
                           tab_operations_staff_2            b,
                           dw_ubn_brn_region c
                     where a.introducer_code = b.staffno
                       and b.branch_code(+) = c.new_branch_code
                       and a.reference_date = in_refdt
                       and c.new_branch_code = '000'
                     group by trim(b.department)) aa,
                   rep_hq_targets bb
             where aa.department(+) = bb.department) \*where department in (in_dept)*\
    ;*/
  end;
  procedure prc_global_dep_cat_tracker(in_refdt in date,
                                       ret      out sys_refcursor) is
  
  begin
    open ret for
      select x.department,
             round(nvl(x.mobilized_amt, 0), 2) casa_mob_amt,
             round(nvl(y.mobilized_amt, 0), 2) time_mob_amt,
             round(nvl(x.mobilized_amt, 0) + nvl(y.mobilized_amt, 0), 2) total_mob_amt,
             nvl(case
                   when (x.mobilized_amt + nvl(y.mobilized_amt, 0)) = 0 then
                    0
                   else
                    round((nvl(x.mobilized_amt, 0) /
                          (x.mobilized_amt + nvl(y.mobilized_amt, 0))) * 100,
                          2)
                 end,
                 0.00) casa_mob_percentage,
             nvl(case
                   when (x.mobilized_amt + nvl(y.mobilized_amt, 0)) = 0 then
                    0
                   else
                    round((nvl(y.mobilized_amt, 0) /
                          (x.mobilized_amt + nvl(y.mobilized_amt, 0))) * 100,
                          2)
                 end,
                 0.00) time_mob_percentage,
             nvl(x.avg_mobilized_amt, 0) casa_avg_mob_amt,
             nvl(y.avg_mobilized_amt, 0) time_avg_mob_amt,
             nvl(x.avg_mobilized_amt + nvl(y.avg_mobilized_amt, 0), 0) tot_avg_mob_amt,
             nvl(case
                   when (x.avg_mobilized_amt + nvl(y.avg_mobilized_amt, 0)) = 0 then
                    0
                   else
                    round((nvl(x.avg_mobilized_amt, 0) /
                          (x.avg_mobilized_amt + nvl(y.avg_mobilized_amt, 0))) * 100,
                          2)
                 end,
                 0.00) casa_avg_mob_percentage,
             nvl(case
                   when (x.avg_mobilized_amt + nvl(y.avg_mobilized_amt, 0)) = 0 then
                    0
                   else
                    round((nvl(y.avg_mobilized_amt, 0) /
                          (x.avg_mobilized_amt + nvl(y.avg_mobilized_amt, 0))) * 100,
                          2)
                 end,
                 0.00) time_avg_mob_percentage
        from (select department, dep_cat, mobilized_amt, avg_mobilized_amt
                from (select 'BRANCHES' department,
                             case
                               when dep_cat in ('SAVINGS', 'CURRENT', 'DOM') then
                                'CASA'
                               else
                                dep_cat
                             end dep_cat,
                             sum(mobilized_amt) mobilized_amt,
                             sum(avg_mobilized_amt) avg_mobilized_amt
                        from (select a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code <> '000'
                              /*union all
                              select a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                 and a.dep_cat = 'TIME'
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code <> '000'*/
                              )
                       group by case
                                  when dep_cat in
                                       ('SAVINGS', 'CURRENT', 'DOM') then
                                   'CASA'
                                  else
                                   dep_cat
                                end
                      union all
                      select department department,
                             case
                               when dep_cat in ('SAVINGS', 'CURRENT', 'DOM') then
                                'CASA'
                               else
                                dep_cat
                             end dep_cat,
                             nvl(sum(mobilized_amt), 0) mobilized_amt,
                             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt
                        from (select d.department,
                                     a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code = '000'
                              /* union all
                              select e.department,
                                     a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                 and a.dep_cat = 'TIME'
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code = '000'*/
                              )
                       group by department,
                                case
                                  when dep_cat in
                                       ('SAVINGS', 'CURRENT', 'DOM') then
                                   'CASA'
                                  else
                                   dep_cat
                                end)
               where dep_cat = 'CASA') x,
             (select department, dep_cat, mobilized_amt, avg_mobilized_amt
                from (select 'BRANCHES' department,
                             case
                               when dep_cat in ('SAVINGS', 'CURRENT', 'DOM') then
                                'CASA'
                               else
                                dep_cat
                             end dep_cat,
                             sum(mobilized_amt) mobilized_amt,
                             sum(avg_mobilized_amt) avg_mobilized_amt
                        from (select a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code <> '000'
                              union all
                              select a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                 and a.dep_cat = 'TIME'
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code <> '000')
                       group by case
                                  when dep_cat in
                                       ('SAVINGS', 'CURRENT', 'DOM') then
                                   'CASA'
                                  else
                                   dep_cat
                                end
                      union all
                      select department department,
                             case
                               when dep_cat in ('SAVINGS', 'CURRENT', 'DOM') then
                                'CASA'
                               else
                                dep_cat
                             end dep_cat,
                             nvl(sum(mobilized_amt), 0) mobilized_amt,
                             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt
                        from (select d.department,
                                     a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_cust_account@fcubs_dr b,
                                     dw_ubn_brn_region c,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) d
                               where a.cust_ac_no = b.cust_ac_no
                                 and a.branch_code = c.new_branch_code
                                 and a.introducer_code = d.staffno
                                 and a.reference_date = in_refdt
                                 and c.new_branch_code = '000'
                              union all
                              select e.department,
                                     a.dep_cat,
                                     a.mobilized_amt,
                                     a.avg_mobilized_amt
                                from services_tracker_all a,
                                     sttm_customer@fcubs_dr b,
                                     cstb_contract@fcubs_dr c,
                                     dw_ubn_brn_region d,
                                     (select *
                                        from tab_operations_staff_2
                                       where staffno in
                                             (select emp_number
                                                from ubn_employee_details
                                               where sbu =
                                                     'Service and Technology')) e
                               where a.cust_no = b.customer_no
                                 and a.cust_ac_no = c.contract_ref_no
                                 and a.branch_code = d.new_branch_code
                                 and a.introducer_code = e.staffno
                                 and a.dep_cat = 'TIME'
                                 and a.reference_date = in_refdt
                                 and d.new_branch_code = '000')
                       group by department,
                                case
                                  when dep_cat in
                                       ('SAVINGS', 'CURRENT', 'DOM') then
                                   'CASA'
                                  else
                                   dep_cat
                                end)
               where dep_cat = 'TIME') y
       where x.department = y.department(+);
  end;
  procedure prc_global_cat_deposit_tracker(in_refdt in date,
                                           ret      out sys_refcursor) is
  
  begin
    open ret for
      select *
        from (select 'BRANCHES' department,
                     bb.cat,
                     bb.base_lcy_bal,
                     bb.curr_lcy_bal,
                     aa.current_target / 2 target,
                     bb.mobilized_amt,
                     bb.avg_mobilized_amt
                from (select round(sum(target) *
                                   to_number(to_char(in_refdt, 'MM'))) current_target
                        from dep_branch_targets) aa,
                     (select decode(a.dep_cat,
                                    'SAVINGS',
                                    'CASA',
                                    'CURRENT',
                                    'CASA',
                                    'DOM',
                                    'CASA',
                                    dep_cat) cat,
                             sum(a.base_lcy_bal) base_lcy_bal,
                             sum(a.curr_lcy_bal) curr_lcy_bal,
                             sum(a.mobilized_amt) mobilized_amt,
                             sum(a.avg_mobilized_amt) avg_mobilized_amt
                        from services_tracker_all a,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) b,
                             dw_ubn_brn_region c
                       where a.introducer_code = b.staffno
                         and b.branch_code(+) = c.new_branch_code
                         and a.reference_date = in_refdt
                         and c.new_branch_code <> '000'
                       group by decode(a.dep_cat,
                                       'SAVINGS',
                                       'CASA',
                                       'CURRENT',
                                       'CASA',
                                       'DOM',
                                       'CASA',
                                       dep_cat)) bb
              union all
              select aa.department,
                     aa.cat,
                     aa.base_lcy_bal,
                     aa.curr_lcy_bal,
                     bb.target,
                     aa.mobilized_amt,
                     aa.avg_mobilized_amt
                from (select b.department,
                             decode(a.dep_cat,
                                    'SAVINGS',
                                    'CASA',
                                    'CURRENT',
                                    'CASA',
                                    'DOM',
                                    'CASA',
                                    dep_cat) cat,
                             sum(a.base_lcy_bal) base_lcy_bal,
                             sum(a.curr_lcy_bal) curr_lcy_bal,
                             sum(a.mobilized_amt) mobilized_amt,
                             sum(a.avg_mobilized_amt) avg_mobilized_amt
                        from services_tracker_all a,
                             (select *
                                from tab_operations_staff_2
                               where staffno in
                                     (select emp_number
                                        from ubn_employee_details
                                       where sbu = 'Service and Technology')) b,
                             dw_ubn_brn_region c
                       where a.introducer_code = b.staffno
                         and b.branch_code(+) = c.new_branch_code
                         and a.reference_date = in_refdt
                         and c.new_branch_code = '000'
                       group by b.department,
                                decode(a.dep_cat,
                                       'SAVINGS',
                                       'CASA',
                                       'CURRENT',
                                       'CASA',
                                       'DOM',
                                       'CASA',
                                       dep_cat)) aa,
                     rep_hq_targets bb
               where aa.department = bb.department) /*where department in (in_dept)*/
      ;
  end prc_global_cat_deposit_tracker;
  procedure prc_icms_chqbk_by_acct(in_startdt in date,
                                   in_enddt   in date,
                                   in_branch  in varchar2,
                                   in_account in varchar2,
                                   --  in_proc    in varchar2,
                                   ret out sys_refcursor) is
  begin
    open ret for
      select a.region,
             a.zone_name,
             c.branch receiving_branch_code,
             a.branch_name receiving_branch_name,
             e.branch_addr2 receiving_branch_state,
             c.account,
             c.first_check_no,
             c.check_leaves,
             c.order_date,
             c.issue_date,
             c.order_details,
             c.maker_id,
             c.maker_dt_stamp,
             c.checker_id,
             c.checker_dt_stamp,
             f.branch_name checker_branch_name,
             round((nvl(c.checker_dt_stamp, sysdate) - c.maker_dt_stamp) * 24 * 60,
                   0) timetaken,
             c.mod_no,
             c.once_auth,
             c.auth_stat,
             c.record_stat,
             c.chq_type,
             c.print_status,
             c.external_ref_no,
             c.incl_for_chkbook_printing,
             c.delivery_ref_no,
             c.delivery_mode,
             c.delivery_date,
             c.chqbook_deliverd,
             c.cheque_book_type,
             c.delivery_add1,
             c.delivery_add2,
             c.delivery_add3,
             c.delivery_add4,
             c.language_code,
             c.request_mode,
             c.request_status,
             c.trn_ref_no,
             c.seq_no,
             c.req_queue_date,
             c.is_sent_for_proc,
             c.account_name,
             c.req_proc_date,
             c.resp_control_no_start,
             c.resp_control_no_end,
             c.resp_date,
             c.resp_file_name,
             c.account_class,
             c.currency,
             c.branch_sort_code,
             d.lcy_amount
        from icms.catm_check_book_rep@fcubs_dr c,
             sttm_cust_account@fcubs_dr b,
             dw_ubn_brn_region a,
             acvw_all_ac_entries d,
             dw_sttm_branch e,
             (select user_id, home_branch, branch_name
                from smtb_user@fcubs_dr a, dw_sttm_branch b
               where a.home_branch = b.branch_code) f
       where c.account = b.cust_ac_no
         and c.branch = a.new_branch_code(+)
         and c.trn_ref_no = d.trn_ref_no(+)
         and c.account = d.ac_no(+)
         and a.new_branch_code = e.branch_code
         and c.checker_id = f.user_id
         and trunc(c.req_proc_date) between in_startdt and in_enddt
         and (c.branch = in_branch or in_branch = 'ALL')
         and (c.account = in_account or in_account = 'ALL')
         and (c.branch = in_branch or in_branch = 'ALL');
  end;
  procedure prc_accts_expired_id(ret out sys_refcursor) is
  begin
    open ret for
      select v.branch_code branch_code,
             z.branch_name,
             v.cust_no customer_id,
           --  u.account_no,
           --  u.account_name,
           ---  u.account_open_date,
           --  u.account_type,
           --  u.account_indicator,
         --   u.vision_sbu segment_code,
           --  u.scheme_code account_class,
             o.description account_class_name,
             y.mi_id_type,
             y.mi_id_no,
             v.acy_avl_bal balance,
             y.mi_id_issue_date,
             y.mi_id_expiry_date,
             --u.account_officer rm_code,
             m.full_name rm_name,
             v.ac_stat_no_dr pnd_status,
             greatest(date_last_cr, date_last_dr) last_txn_date,
             v.record_stat
        from tmp_ftr_adrap_02 y,
             --vision.customer_extras@mdm  y,
             dw_sttm_branch        z,
             dw_cust_account  v,
           --  vision.accounts_dly@mdm     u,
             dw_account_class o,
             ubn_employee_details        m
       where y.customer_no = v.cust_no
       --  and v.cust_ac_no = u.account_no
         and v.branch_code = z.branch_code
        -- and u.account_officer = m.emp_number
         and v.account_class = o.account_class
         and y.mi_id_expiry_date <= trunc(sysdate) + 30
         and v.record_stat = 'O';
       --order by y.mi_id_expiry_date;
  end prc_accts_expired_id;

  procedure prc_star_tat_byapprvdt(p_start_date in date,
                                   p_end_date   in date,
                                   ret          out sys_refcursor) is
  begin
  
    execute immediate 'truncate table task_max_apprvdt';
    insert into task_max_apprvdt
      (select distinct a.workitemid, max(a.datecompleted) approval_end_date
         from str_opstask a
        where a.datecompleted between p_start_date and p_end_date
          and a.isdeleted = 0
        group by a.workitemid);
    commit;
  
    execute immediate 'truncate table star_tat_rpt';
    insert into star_tat_rpt
      select c.datecreated item_creation_date,
             c.accountname,
             c.name workitemid,
             c.loanamount,
             g.emailaddress,
             g.firstname || ' ' || g.middlename || ' ' || g.surname initiator,
             turnaroundtime,
             e.name division,
             b.firstname || ' ' || b.middlename || ' ' || b.surname staffname,
             d.name,
             a.datecreated approver_begin_date,
             a.datecompleted approval_end_date,
             case
               when a.completedbyuserid is not null then
                extract(day from cast(a.datecompleted as timestamp) -
                        cast(a.datecreated as timestamp)) || '.' ||
                extract(hour from cast(a.datecompleted as timestamp) -
                        cast(a.datecreated as timestamp)) || ':' ||
                extract(minute from cast(a.datecompleted as timestamp) -
                        cast(a.datecreated as timestamp))
               else
                extract(day from cast(sysdate as timestamp) -
                        cast(a.datecreated as timestamp)) || '.' ||
                extract(hour from cast(sysdate as timestamp) -
                        cast(a.datecreated as timestamp)) || ':' ||
                extract(minute from cast(sysdate as timestamp) -
                        cast(a.datecreated as timestamp))
             end time_lapse,
             regexp_replace(utl_i18n.unescape_reference(dbms_lob.substr(comments,
                                                                        3000)),
                            '<.*?>') comments,
             case a.response
               when 1 then
                'Approved'
               when 2 then
                'Rejected'
               when 4 then
                'Review Requested'
               else
                'Others'
             end response,
             extract(day from cast(f.approval_end_date as timestamp) -
                     cast(c.datecreated as timestamp)) || '.' ||
             extract(hour from cast(f.approval_end_date as timestamp) -
                     cast(c.datecreated as timestamp)) || ':' ||
             extract(minute from cast(f.approval_end_date as timestamp) -
                     cast(c.datecreated as timestamp)) global_approval_time,
             c.workflowstatus
        from str_workitems_new c,
             str_opstask       a,
             str_users         b,
             str_opsgroups     d,
             str_businessunits e,
             str_users         g,
             task_max_apprvdt  f
       where c.id = a.workitemid
         and a.workitemid = f.workitemid
         and a.completedbyuserid = b.id(+)
         and c.initiatinguserid = g.id
         and a.groupcode = d.code
         and b.businessunitid = e.id(+);
    commit;
    open ret for
      select * from star_tat_rpt;
  
  end prc_star_tat_byapprvdt;

  procedure prc_collateral_det_exprd(ret out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     dw_getm_liab                          c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (old_reval_date < trunc(sysdate) OR old_reval_date IS NULL);
  
  end;
  procedure prc_collateral_det_90days(ret out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     dw_getm_liab                          c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (old_reval_date between trunc(sysdate) and trunc(sysdate) + 90 OR old_reval_date IS NULL);
  
  end;
  procedure prc_collateral_det_range(in_startdt in date,
                                     in_enddt   in date,
                                     ret        out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     dw_getm_liab                          c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (old_reval_date between in_startdt and in_enddt OR old_reval_date IS NULL);
  
  end;
  procedure prc_collateral_insr_exprd(ret out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     getm_liab@fcubs_dr                           c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (ins_end_date < trunc(sysdate) or ins_end_date is null);
  
  end;
  procedure prc_collateral_ins_90days(ret out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     dw_getm_liab                          c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (ins_end_date between trunc(sysdate) and (trunc(sysdate) + 90) OR ins_end_date IS NULL);
  
  end;
  procedure prc_collateral_ins_range(in_startdt in date,
                                     in_enddt   in date,
                                     ret        out sys_refcursor) is
  begin
    open ret for
      select liab_id,
             liab_no,
             customer_name,
             liab_branch,
             branch_name,
             cbn_code,
             cbn_collateral_type,
             m.category_id,
             collateral_desc,
             collateral_code,
             charge_type,
             collateral_description,
             secured_type,
             collateral_currency,
             collateral_value,
             limit_contribution,
             haircut_percent,
             m.collateral_type,
             start_date,
             end_date,
             old_reval_date,
             collateral_address,
             state,
             om_value,
             fs_value,
             ins_value,
             s_rvalue,
             valuer,
             status,
             asset_insured,
             insurance_co,
             val_st_date,
             reval_date,
             st_date,
             expiry_date,
             premium,
             verified,
             asset_status,
             asset_charge,
             trustee_name,
             legal_status,
             insurance_comment,
             valuation_comment,
             category_name,
             share_percentage,
             contract_ref_no,
             contract_branch,
             contract_contribution,
             insurance_no,
             insurance_name,
             insurance_owner,
             insurance_type,
             ins_start_date,
             ins_end_date,
             insurance_amt,
             premium_amt,
             premium_end_date,
             maker_id,
             checker_id,
             maker_dt_stamp,
             checker_dt_stamp,
             nvl(total_fs_value, 0) total_fs_value,
             nvl(total_fs_value_cat, 0) total_fs_value_cat,
             p.groupname,
             classification,
             region,
             major_biz_segment,
             relationship_manager
        from (select distinct a.liab_id,
                              lpad(a.liab_id, 9, '0') customer_no,
                              c.liab_no,
                              c.liab_name customer_name,
                              c.liab_branch,
                              e.branch_name,
                              i.cbn_code,
                              i.collateral_type cbn_collateral_type,
                              a.category_id,
                              (select description
                                 from getm_coll_category@fcubs_dr
                                where id = a.category_id) collateral_desc,
                              a.collateral_code,
                              a.charge_type,
                              a.collateral_description,
                              a.secured secured_type,
                              a.collateral_currency,
                              a.collateral_value,
                              a.limit_contribution,
                              a.haircut haircut_percent,
                              a.collateral_type,
                              a.start_date,
                              a.end_date,
                              a.reval_date old_reval_date,
                              trim(a.udf_value_1) collateral_address,
                              a.udf_value_2 state,
                              a.udf_value_3 om_value,
                              a.udf_value_4 fs_value,
                              a.udf_value_10 ins_value,
                              a.udf_value_5 s_rvalue,
                              a.udf_value_6 valuer,
                              a.udf_value_7 status,
                              a.udf_value_9 asset_insured,
                              a.udf_value_8 insurance_co,
                              a.udf_value_15 val_st_date,
                              a.udf_value_16 reval_date,
                              a.udf_value_12 st_date,
                              a.udf_value_13 expiry_date,
                              a.udf_value_11 premium,
                              a.udf_value_14 verified,
                              a.udf_value_17 asset_status,
                              a.udf_value_18 asset_charge,
                              a.udf_value_19 trustee_name,
                              a.udf_value_20 legal_status,
                              a.udf_value_21 insurance_comment,
                              a.udf_value_22 valuation_comment,
                              d.description category_name,
                              f.share_percentage,
                              g.contract_ref_no,
                              g.contract_branch,
                              g.contract_contribution,
                              h.insurance_no,
                              h.insurance_name,
                              h.insurance_owner,
                              h.insurance_type,
                              h.start_date ins_start_date,
                              h.end_date ins_end_date,
                              h.insurance_amt,
                              h.premium_amt,
                              h.premium_end_date,
                              a.maker_id,
                              a.checker_id,
                              a.maker_dt_stamp,
                              a.checker_dt_stamp,
                              yy.classification,
                              zz.region,
                              yy.major_biz_segment,
                              yy.relationship_manager
                from fcubslive.getm_collat@fcubs_dr              a,
                     fcubslive.cltb_account_master@fcubs_dr      b,
                     dw_getm_liab                          c,
                     fcubslive.getm_coll_category@fcubs_dr       d,
                     dw_sttm_branch                        e,
                     fcubslive.getm_collat_share@fcubs_dr        f,
                     fcubslive.getm_collat_cont_contrib@fcubs_dr g,
                     fcubslive.getm_coll_insurance@fcubs_dr      h,
                     crm_cbn_collateral_codes                    i,
                     crm_clr_report_new                          yy,
                     crm_branch_region                           zz
               where lpad(a.liab_id, 9, '0') = b.customer_id(+)
                 and a.liab_id = c.id
                 and a.liab_id = f.liab_id(+)
                 and f.coll_id = g.coll_id(+)
                 and a.id = h.collateral_id(+)
                 and to_char(a.category_id) = i.fcubs_code(+)
                 and b.customer_id = yy.cust_no(+)
                 and yy.branch_code = zz.branch_code(+)
                 and a.auth_stat = 'A'
                 and nvl(b.auth_stat, 'A') = 'A'
                 and a.category_id = d.id(+)
                 and a.record_stat = 'O'
                 and c.auth_stat = 'A'
                 and c.liab_branch = e.branch_code(+)
                 and a.maker_id <> 'MIGUSER'
                 and a.maker_id <> 'MIGFCCUSER') m,
             
             (select cust_id, sum(nvl(collateral_value, 0)) total_fs_value
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id) n,
             
             (select cust_id,
                     category_id,
                     sum(nvl(collateral_value, 0)) total_fs_value_cat
                from (select cust_id,
                             category_id,
                             collateral_value,
                             row_number() over(partition by cust_id, collateral_code, collateral_value order by cust_id asc) rnk
                        from collateral_dtls)
               where rnk = 1
               group by cust_id, category_id) o,
             
             (select distinct aa.cust_no, aa.groupname
                from crm_corpsme_sector_map aa) p
      
       where trim(m.liab_no) = trim(n.cust_id(+))
         and trim(m.liab_no) = trim(o.cust_id(+))
         and trim(m.liab_no) = trim(p.cust_no(+))
         and m.category_id = o.category_id(+)
         and m.cbn_code in ('SEC015','SEC001','SEC021','SEC012','SEC006','SEC002','SEC025','SEC026')
         and (ins_end_date between in_startdt and in_enddt OR ins_end_date IS NULL);
  
  end;

  procedure prc_eodm_escalation(p_branch_code in varchar2,
                                ret           out sys_refcursor) is
  begin
    open ret for
      select aa.branch_code || ' - ' || initcap(aa.branch_name) branch_detail,
             aa.*,
             bb.full_name bsm,
             bb.email bsm_email,
             bb.job_role bsm_job_role,
             cc.email zsm_email,
             cc.job_role zsm_job_role
        from fcubslive.fbtm_branch_info@fcubs_dr aa,
             ubn_employee_details                bb,
             ubn_employee_details                cc
       where trunc(currentpostingdate) = trunc(sysdate)
         and aa.branch_code not in ('002',
                                    '003',
                                    '005',
                                    '004',
                                    '007',
                                    '008',
                                    '009',
                                    '016',
                                    '017',
                                    '018',
                                    '022')
         and aa.branch_code = bb.branch_code(+)
         and bb.line_manager_number = cc.emp_number(+)
         and bb.job_role = 'Branch Service Manager (BSM)'
         and cc.job_role != 'Branch Service Manager (BSM)'
         and aa.branch_code = p_branch_code;
  
  end prc_eodm_escalation;

  procedure prc_cpc_priority(p_start_dt in date,
                             p_end_dt   in date,
                             ret        out sys_refcursor) is
  begin
    open ret for
      select txn_date,
             user_id,
             full_name,
             function_id,
             sum(txn_cnt) txn_cnt
        from ((select trunc(a.maker_dt_stamp) txn_date,
                      a.maker_id user_id,
                      d.full_name,
                      a.function_id,
                      count(distinct a.key_id) txn_cnt
                 from fcubslive.sttb_record_log@fcubs_dr a,
                      fcubslive.smtb_user@fcubs_dr       b,
                      fcubslive.fbtm_branch@fcubs_dr     c,
                      ubn_employee_details               d
                where a.auth_stat = 'A'
                  and a.maker_id = b.user_id
                  and b.home_branch = c.branch_code
                  and lower(a.maker_id) = lower(d.username)
                  and trim(c.branch_name) = 'UBN HEAD OFFICE'
                  and trunc(a.maker_dt_stamp) between p_start_dt and
                      p_end_dt
                  and lower(a.maker_id) in
                      ('ijibidapo',
                       'dnahmodu',
                       'jafeigbe',
                       'sasalami',
                       'ajilikannu',
                       'ogakinfolurin',
                       'eowilson',
                       'oaawokoya',
                       'jinwanegwo',
                       'ibrabubakar',
                       'kaaliyu',
                       'ooakindele',
                       'ososikalu',
                       'neik-onyeno',
                       'ahaidowu',
                       'ooefe-louis',
                       'fkikuteyijo',
                       'ebadebambo')
                group by trunc(a.maker_dt_stamp),
                         a.maker_id,
                         a.function_id,
                         d.full_name
               
               union all
               
               select trunc(a.maker_dt_stamp) txn_date,
                      a.checker_id user_id,
                      d.full_name,
                      a.function_id,
                      count(distinct a.key_id) txn_cnt
                 from fcubslive.sttb_record_log@fcubs_dr a,
                      fcubslive.smtb_user@fcubs_dr       b,
                      fcubslive.fbtm_branch@fcubs_dr     c,
                      ubn_employee_details               d
                where a.auth_stat = 'A'
                  and a.maker_id = b.user_id
                  and b.home_branch = c.branch_code
                  and lower(a.checker_id) = lower(d.username)
                  and trim(c.branch_name) = 'UBN HEAD OFFICE'
                  and trunc(a.maker_dt_stamp) between p_start_dt and
                      p_end_dt
                  and lower(a.checker_id) in
                      ('ijibidapo',
                       'dnahmodu',
                       'jafeigbe',
                       'sasalami',
                       'ajilikannu',
                       'ogakinfolurin',
                       'eowilson',
                       'oaawokoya',
                       'jinwanegwo',
                       'ibrabubakar',
                       'kaaliyu',
                       'ooakindele',
                       'ososikalu',
                       'neik-onyeno',
                       'ahaidowu',
                       'ooefe-louis',
                       'fkikuteyijo',
                       'ebadebambo')
                group by trunc(a.maker_dt_stamp),
                         a.checker_id,
                         a.function_id,
                         d.full_name)
             
              union all
             
              (select trunc(a.maker_dt_stamp) txn_date,
                      a.maker_id user_id,
                      d.full_name,
                      a.function_id,
                      count(distinct a.key_id) txn_cnt
                 from fcubslive.sttb_record_log_hist@fcubs_dr a,
                      fcubslive.smtb_user@fcubs_dr            b,
                      fcubslive.fbtm_branch@fcubs_dr          c,
                      ubn_employee_details                    d
                where a.auth_stat = 'A'
                  and a.maker_id = b.user_id
                  and b.home_branch = c.branch_code
                  and lower(a.maker_id) = lower(d.username)
                  and trim(c.branch_name) = 'UBN HEAD OFFICE'
                  and trunc(a.maker_dt_stamp) between p_start_dt and p_end_dt
                  and lower(a.maker_id) in
                      ('ijibidapo',
                       'dnahmodu',
                       'jafeigbe',
                       'sasalami',
                       'ajilikannu',
                       'ogakinfolurin',
                       'eowilson',
                       'oaawokoya',
                       'jinwanegwo',
                       'ibrabubakar',
                       'kaaliyu',
                       'ooakindele',
                       'ososikalu',
                       'neik-onyeno',
                       'ahaidowu',
                       'ooefe-louis',
                       'fkikuteyijo',
                       'ebadebambo')
                group by trunc(a.maker_dt_stamp),
                         a.maker_id,
                         a.function_id,
                         d.full_name
               
               union all
               
               select trunc(a.maker_dt_stamp) txn_date,
                      a.checker_id user_id,
                      d.full_name,
                      a.function_id,
                      count(distinct a.key_id) txn_cnt
                 from fcubslive.sttb_record_log_hist@fcubs_dr a,
                      fcubslive.smtb_user@fcubs_dr            b,
                      fcubslive.fbtm_branch@fcubs_dr          c,
                      ubn_employee_details                    d
                where a.auth_stat = 'A'
                  and a.maker_id = b.user_id
                  and b.home_branch = c.branch_code
                  and lower(a.checker_id) = lower(d.username)
                  and trim(c.branch_name) = 'UBN HEAD OFFICE'
                  and trunc(a.maker_dt_stamp) between p_start_dt and p_end_dt
                  and lower(a.checker_id) in
                      ('ijibidapo',
                       'dnahmodu',
                       'jafeigbe',
                       'sasalami',
                       'ajilikannu',
                       'ogakinfolurin',
                       'eowilson',
                       'oaawokoya',
                       'jinwanegwo',
                       'ibrabubakar',
                       'kaaliyu',
                       'ooakindele',
                       'ososikalu',
                       'neik-onyeno',
                       'ahaidowu',
                       'ooefe-louis',
                       'fkikuteyijo',
                       'ebadebambo')
                group by trunc(a.maker_dt_stamp),
                         a.checker_id,
                         a.function_id,
                         d.full_name))
       group by txn_date, user_id, full_name, function_id;
  
  end prc_cpc_priority;
  procedure prc_deposit_tracker_risk(in_refdt in date,
                                     ret      out sys_refcursor) is
  begin
    open ret for
      select 'Risk Group' region,
             aa.department,
             nvl(count(cust_ac_no), 0) no_of_ac_opened,
             nvl(sum(base_lcy_bal), 0) base_lcy_bal,
             nvl(sum(curr_lcy_bal), 0) curr_lcy_bal,
             nvl(sum(mobilized_amt), 0) mobilized_amt,
             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt,
             aa.target
        from (select trim(department) department, sum(target) target
                from risk_dp_targets
               where trim(department) not in
                     ('Treasury Operation', 'Finance And Strategy')
               group by trim(department)) aa,
             (select c.org_dept,
                     b.ac_desc,
                     trim(c.department) department,
                     trim(c.unit) unit,
                     c.department_code,
                     a.*,
                     b.ac_open_date,
                     c.full_name,
                     c.target
                from services_tracker_all       a,
                     sttm_cust_account@fcubs_dr b,
                     risk_dp_targets            c
               where a.introducer_code = c.emp_number
                 and a.cust_ac_no = b.cust_ac_no
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                    -- and a.mobilized_amt > 0
                 and a.reference_date(+) = in_refdt
              
              union all
              select d.org_dept,
                     trim(nvl(b.full_name, customer_name1)),
                     trim(d.department) department,
                     trim(d.unit) unit,
                     d.department_code,
                     a.*,
                     c.book_date,
                     d.full_name,
                     d.target
                from services_tracker_all   a,
                     sttm_customer@fcubs_dr b,
                     cstb_contract@fcubs_dr c,
                     risk_dp_targets        d /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 tmp_dep_td_contra_ac_opn_dt f*/
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.introducer_code = d.emp_number
                    --and a.cust_ac_no = f.cust_ac_no
                 and a.dep_cat = 'TIME'
                    /* and to_char(f.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt) bb --in_refdt)
       where aa.department = bb.department(+)
       group by aa.department, aa.target;
  end;

  procedure prc_deposit_tracker_riskdtls(in_refdt in date,
                                         in_dept  varchar2,
                                         ret      out sys_refcursor) is
  begin
    open ret for
      select aa.department,
             aa.unit,
             nvl(count(cust_ac_no), 0) no_of_ac_opened,
             nvl(sum(base_lcy_bal), 0) base_lcy_bal,
             nvl(sum(curr_lcy_bal), 0) curr_lcy_bal,
             nvl(sum(mobilized_amt), 0) mobilized_amt,
             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt,
             aa.target
        from (select trim(department) department,
                     trim(unit) unit,
                     sum(target) target
                from risk_dp_targets
               group by trim(department), trim(unit)) aa,
             (select c.org_dept,
                     b.ac_desc,
                     trim(c.department) department,
                     nvl(trim(c.unit), trim(c.department)) unit,
                     c.department_code,
                     a.*,
                     b.ac_open_date,
                     c.full_name,
                     c.target
                from services_tracker_all       a,
                     sttm_cust_account@fcubs_dr b,
                     risk_dp_targets            c
               where a.introducer_code = c.emp_number
                 and a.cust_ac_no = b.cust_ac_no
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                    -- and a.mobilized_amt > 0
                 and a.reference_date = in_refdt
                 and trim(c.department) = in_dept
              union all
              select d.org_dept,
                     trim(nvl(b.full_name, customer_name1)),
                     trim(d.department) department,
                     trim(d.unit) unit,
                     d.department_code,
                     a.*,
                     c.book_date,
                     d.full_name,
                     d.target
                from services_tracker_all   a,
                     sttm_customer@fcubs_dr b,
                     cstb_contract@fcubs_dr c,
                     risk_dp_targets        d /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 tmp_dep_td_contra_ac_opn_dt f*/
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.introducer_code = d.emp_number
                    -- and a.cust_ac_no = f.cust_ac_no
                 and a.dep_cat = 'TIME'
                    /* and to_char(f.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and trim(d.department) = in_dept) bb
       where aa.department = bb.department(+)
         and aa.unit = bb.unit(+)
       group by aa.department, aa.unit, aa.target;
  end;

  procedure prc_deposit_tracker_riskdetail(in_refdt in date,
                                           in_unit  varchar2,
                                           ret      out sys_refcursor) is
  begin
    open ret for
      select aa.department,
             aa.unit,
             aa.department_code,
             aa.emp_number,
             aa.full_name,
             nvl(count(cust_ac_no), 0) no_of_ac_opened,
             nvl(sum(base_lcy_bal), 0) base_lcy_bal,
             nvl(sum(curr_lcy_bal), 0) curr_lcy_bal,
             nvl(sum(mobilized_amt), 0) mobilized_amt,
             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt,
             aa.target
        from (select department,
                     unit,
                     department_code,
                     emp_number,
                     full_name,
                     sum(target) target
                from risk_dp_targets
               group by department,
                        unit,
                        department_code,
                        emp_number,
                        full_name) aa,
             (select c.org_dept,
                     b.ac_desc,
                     c.department,
                     c.unit,
                     c.department_code,
                     a.*,
                     b.ac_open_date,
                     c.full_name,
                     c.target
                from services_tracker_all       a,
                     sttm_cust_account@fcubs_dr b,
                     risk_dp_targets            c
               where a.introducer_code = c.emp_number
                 and a.cust_ac_no = b.cust_ac_no
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                    --  and a.mobilized_amt > 0
                 and a.reference_date(+) = in_refdt
                 and c.unit = in_unit
              union all
              select d.org_dept,
                     trim(nvl(b.full_name, customer_name1)),
                     d.department,
                     d.unit,
                     d.department_code,
                     a.*,
                     c.book_date,
                     d.full_name,
                     d.target
                from services_tracker_all   a,
                     sttm_customer@fcubs_dr b,
                     cstb_contract@fcubs_dr c,
                     risk_dp_targets        d /*,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 tmp_dep_td_contra_ac_opn_dt f*/
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.introducer_code = d.emp_number
                    --  and a.cust_ac_no = f.cust_ac_no
                 and a.dep_cat = 'TIME'
                    /* and to_char(f.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and d.unit = in_unit) bb
       where aa.department = bb.department(+)
         and aa.unit = bb.unit(+)
         and aa.emp_number = bb.introducer_code(+)
       group by aa.department,
                aa.unit,
                aa.department_code,
                aa.emp_number,
                aa.full_name,
                aa.target;
  end;
  procedure prc_rdeposit_tracker_details(in_refdt   in date,
                                         in_staffno varchar2,
                                         ret        out sys_refcursor) is
  begin
    open ret for
      select department,
             unit,
             department_code,
             introducer_code,
             full_name,
             cust_ac_no,
             ac_desc,
             ac_open_date,
             dep_cat,
             ccy_code,
             account_class,
             org_dept,
             nvl(count(cust_ac_no), 0) no_of_ac_opened,
             nvl(sum(base_lcy_bal), 0) base_lcy_bal,
             nvl(sum(curr_lcy_bal), 0) curr_lcy_bal,
             nvl(sum(mobilized_amt), 0) mobilized_amt,
             nvl(sum(avg_mobilized_amt), 0) avg_mobilized_amt,
             target
        from (select c.org_dept,
                     b.ac_desc,
                     c.department,
                     c.unit,
                     c.department_code,
                     a.*,
                     b.ac_open_date,
                     c.full_name,
                     c.target
                from services_tracker_all       a,
                     sttm_cust_account@fcubs_dr b,
                     risk_dp_targets            c
               where a.introducer_code = c.emp_number
                 and a.cust_ac_no = b.cust_ac_no
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                    --  and a.mobilized_amt > 0
                 and a.reference_date = in_refdt
                 and a.introducer_code = in_staffno
              union all
              select d.org_dept,
                     trim(nvl(b.full_name, customer_name1)),
                     d.department,
                     unit,
                     d.department_code,
                     a.*,
                     c.book_date,
                     d.full_name,
                     d.target
                from services_tracker_all   a,
                     sttm_customer@fcubs_dr b,
                     cstb_contract@fcubs_dr c,
                     risk_dp_targets        d /*,
                                                                                                                                                                                                                                                                                                                                                                                   tmp_dep_td_contra_ac_opn_dt f*/
               where a.cust_no = b.customer_no
                 and a.cust_ac_no = c.contract_ref_no
                 and a.introducer_code = d.emp_number
                    --   and a.cust_ac_no = f.cust_ac_no
                 and a.dep_cat = 'TIME'
                    /* and to_char(f.ac_open_date, 'YYYY') =
                    to_char(trunc(sysdate), 'YYYY')*/
                 and to_char(a.reference_date, 'YYYY') =
                     to_char(trunc(sysdate), 'YYYY')
                 and a.reference_date = in_refdt
                 and a.introducer_code = in_staffno) bb
       group by department,
                unit,
                department_code,
                introducer_code,
                full_name,
                cust_ac_no,
                ac_desc,
                ac_open_date,
                dep_cat,
                ccy_code,
                account_class,
                org_dept,
                target;
  end;
end pkg_ssrs_reports_4;


4.Collateral Monitoring â€“ Expiring Insurance within 90 days>>DWH<<stg_uat.PKG_SSRS_REPORTS_4.PRC_COLLATERAL_INS_90DAYS


5.Collateral Monitoring â€“ Expiring Valuate within 90 days>>>DWH<<<stg_uat.PKG_SSRS_REPORTS_4.PRC_COLLATERAL_DET_90DAYS


6.Collateral Monitoring â€“ Insurance Expiration date range>>>>DWH<<<stg_uat.PKG_SSRS_REPORTS_4.PRC_COLLATERAL_INS_RANGE


7.Collateral Monitoring â€“ valuation Expiration date range>>>>DWH<<<stg_uat.PKG_SSRS_REPORTS_4.PRC_COLLATERAL_DET_RANGE
